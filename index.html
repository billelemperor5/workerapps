<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>لوحة تحكم العامل — My Decor Manager</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  :root{
    --primary:#0f766e;
    --accent:#f59e0b;
    --bg:#f8fafc;
    --card:#ffffff;
    --muted:#6b7280;
    --border-color: rgba(2,6,23,.06);
    --text-primary: #071331;
  }
  body.dark{
    --bg:#071026;
    --card:#0b1220;
    --muted:#9aa6b2;
    --border-color: rgba(255,255,255,.06);
    --text-primary: #f1f5f9;
  }
  html,body{height:100%}
  body{
    margin:0;font-family: 'Tajawal', sans-serif; background:var(--bg); color: var(--text-primary);
    -webkit-font-smoothing:antialiased; display:flex;flex-direction:column;min-height:100vh;
  }
  .splash{
    position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:linear-gradient(135deg,var(--primary),#065f46); color:white; z-index:60;
    transition:opacity .4s ease-out, visibility .4s;
  }
  .splash.hidden{ opacity:0; visibility:hidden; pointer-events:none; }
  .splash-content {
    text-align: center;
    animation: fadeInFromBottom 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }
  @keyframes fadeInFromBottom {
    from { opacity: 0; transform: translateY(25px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .progress-bar { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 28px; height: 20px; }
  .progress-bar div { width: 12px; height: 12px; background-color: var(--accent); border-radius: 50%; animation: pulse 1.4s infinite ease-in-out both; }
  .progress-bar .dot1 { animation-delay: -0.30s; }
  .progress-bar .dot2 { animation-delay: -0.15s; }
  .progress-bar .dot3 { animation-delay: 0s; }
  @keyframes pulse {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
    40% { transform: scale(1.0); opacity: 1; }
  }
  .app-layout {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }
  .app{
    display:flex;
    flex-direction:column;
    flex:1; 
    padding-bottom: 70px;
  }

  header.app-header{
    display:flex; align-items:center; justify-content:space-between; padding:12px 16px; position:sticky; top:0; z-index:40;
    background:rgba(255,255,255,.7); backdrop-filter: blur(6px); border-bottom:1px solid rgba(2,6,23,.04)
  }
  body.dark header.app-header{background:rgba(255,255,255,.02);border-bottom:1px solid rgba(255,255,255,.04)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,var(--primary),#0b8f81);display:flex;align-items:center;justify-content:center;color:white;font-weight:900}
  main{flex:1;overflow:auto;padding:16px;-webkit-overflow-scrolling:touch}

  .hero{background:linear-gradient(90deg,var(--primary),#047857);color:white;padding:16px;border-radius:12px;display:flex;flex-direction:column;gap:10px}
  .kpis{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{background:rgba(255,255,255,0.09);padding:10px;border-radius:10px;min-width:110px;text-align:center}

  .grid-cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:14px}
  
  .card{
    background:var(--card); border-radius:12px; padding:16px; display:flex; flex-direction:column;
    align-items:center; text-align:center; gap:8px; box-shadow:0 10px 30px rgba(2,6,23,.05);
    cursor:pointer; border: 2px solid transparent; position: relative; /* For notification dot */
  }
  .card .icon{
    width:50px; height:50px; border-radius:14px; display:flex; align-items:center;
    justify-content:center; color:white; font-size:20px; margin-bottom: 4px;
  }
  /* *** إضافة: تطبيق التصميم الاحترافي للبطاقات (مثل تطبيق المدير) *** */
  body:not(.dark) .card {
    border: 1px solid rgba(2, 6, 23, 0.1);
    box-shadow: 0 4px 12px rgba(2,6,23,.04);
  }
  body.dark .card {
    border: 1px solid rgba(255, 255, 255, 0.1); /* إطار أبيض شفاف */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); /* ظل داكن خفيف للعمق */
  }

  .btn{background:var(--primary);color:white;padding:6px 10px;border-radius:8px;font-weight:700; border:none; cursor:pointer; font-size: 13px; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center; gap: 6px;}
  .btn.icon-btn { width: 40px; height: 40px; border-radius: 50%; padding: 0; font-size: 18px; flex-shrink: 0; }
  .btn.icon-btn i { margin: 0; }
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,.06);color:var(--primary)}

  .main-nav {
    position: fixed; bottom: 0; left: 0; right: 0; height: 65px;
    background: var(--card); display: flex; justify-content: space-around;
    align-items: center; box-shadow: 0 -2px 10px rgba(2,6,23,.08);
    z-index: 50; border-top: 1px solid var(--border-color);
  }
  .nav-item {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 4px; color: var(--muted); cursor: pointer; font-size: 12px; font-weight: 500;
    flex: 1; height: 100%; position: relative;
  }
  .nav-brand { display: none; }
  .notification-dot {
    position: absolute;
    top: 8px;
    right: 25%;
    width: 10px;
    height: 10px;
    background-color: #ef4444;
    border-radius: 50%;
    border: 2px solid var(--card);
    display: none;
  }
  /* *** إضافة: تنسيقات التنبيه البصري للتحديث الجديد *** */
  .new-update-badge {
    position: absolute;
    top: -10px;
    left: -10px;
    background: var(--accent);
    color: white;
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 800;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transform: rotate(-15deg);
    display: none; /* Hidden by default */
  }
  .card.has-update {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(15, 118, 110, 0.1));
    border-color: var(--primary);
    animation: pulse-border 1.5s infinite;
  }
  .card.has-update .new-update-badge {
    display: block;
  }
  @keyframes pulse-border {
    0%, 100% { box-shadow: 0 0 0 0 rgba(15, 118, 110, 0.4); }
    50% { box-shadow: 0 0 0 6px rgba(15, 118, 110, 0); }
  }
  /* *** تعديل: إصلاح موضع نقطة الإشعار للبطاقات *** */
  .card .notification-dot {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 10px;
    height: 10px;
    border: 2px solid var(--card);
    /* display is controlled by JS */
  }
  /* *** تعديل: تغيير تأثير التوهج إلى اهتزاز أصفر *** */
  @keyframes yellow-shake-animation {
    0%, 100% {
      transform: translateX(0);
      box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
    }
    50% {
      transform: translateX(-1px) scale(1.02);
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.7);
    }
  }
  .btn.glow {
    background-color: var(--accent) !important; /* تغيير اللون إلى الأصفر */
    animation: yellow-shake-animation 0.8s infinite ease-in-out alternate;
  }
  @keyframes pulse-animation {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
    70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
  }
  
  .nav-item:hover { color: var(--primary); }
  .nav-item.active { color: var(--primary); font-weight: 700; }
  .nav-item i { font-size: 20px; }

  .btn, .card, .nav-item {
    transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  .btn:active, .card:active, .nav-item:active {
    transform: scale(0.96);
  }
  .card:hover{
    transform:translateY(-6px);
  }
  .view-container { animation: fadeIn .4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
  .view-container.is-exiting { animation: fadeOut .25s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; pointer-events: none; }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes fadeOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(15px); }
  }
  .nav-item.active i { animation: nav-bounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  @keyframes nav-bounce {
    0%   { transform: translateY(0); }
    50%  { transform: translateY(-5px); }
    100% { transform: translateY(0); }
  }

  @media (min-width: 768px) {
    .app-layout {
        flex-direction: row;
    }
    .main-nav {
        position: sticky; top: 0; width: 240px; height: 100vh;
        flex-direction: column; justify-content: flex-start; align-items: stretch;
        padding: 16px;
        gap: 8px; border-top: none;
        border-left: 1px solid var(--border-color);
        box-sizing: border-box;
    }
    .nav-brand {
        display: flex; align-items: center; gap: 12px;
        padding: 0 0 16px;
        margin-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
        width: 100%;
    }
    .nav-item {
        flex-direction: row; justify-content: flex-start; gap: 12px;
        flex: 0 0 auto; width: 100%;
        height: auto; padding: 10px 12px;
        border-radius: 8px;
        margin: 0;
        box-sizing: border-box;
    }
    .nav-item span { font-size: 14px; }
    .nav-item.active { background-color: rgba(15, 118, 110, 0.1); }
    
    .app {
        .notification-dot {
            top: 8px; right: 8px;
        }
        padding-bottom: 0;
        max-width: none;
        flex-grow: 1;
        margin: 0;
    }
    .grid-cards {
        grid-template-columns: repeat(3, 1fr);
    }
    header.app-header {
        display: none;
    }
    .btn {
      padding: 8px 12px;
      font-size: initial;
    }
    .card .icon {
      width: 60px; height: 60px; border-radius: 16px; font-size: 24px;
    }
  }

  @media (min-width: 1024px) {
    .grid-cards {
        grid-template-columns: repeat(3, 1fr);
    }
  }
  .modal-container {
    position: fixed; inset: 0; z-index: 100;
    display: flex; align-items: center; justify-content: center;
    padding: 16px;
  }
  .modal-backdrop {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(4px);
    animation: fadeIn .3s ease;
  }
  .modal-content {
    position: relative; z-index: 101;
    background: var(--card);
    border-radius: 12px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    animation: fadeInFromBottom .4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    max-height: 90vh;
    display: flex;
    flex-direction: column;
  }
    /* Make modal comfortable on small screens */
    @media (max-width: 480px) {
        .modal-content { max-width: 95%; margin: 0 8px; }
        .modal-body { padding: 12px; }
        .modal-header { padding: 10px 12px; }
    }
  .modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
  }
  .modal-header h3 { margin: 0; font-size: 18px; }
  .modal-header .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); padding: 0 8px; }
  .modal-body { padding: 16px; overflow-y: auto; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
  .form-group input {
    width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
    background: var(--bg); color: var(--text-primary); font-size: 15px; box-sizing: border-box;
  }
  .form-group textarea {
    width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
    background: var(--bg); color: var(--text-primary); font-size: 15px; box-sizing: border-box;
    font-family: 'Tajawal', sans-serif;
    resize: vertical;
    min-height: 80px;
    line-height: 1.6;
  }
  .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
  .modal-container.is-exiting .modal-content { animation: fadeOut .25s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
  .modal-container.is-exiting .modal-backdrop { animation: fadeOut .25s ease forwards; }
  #deleteWorkerBtn {
    background-color: #ef4444;
    color: white;
  }
  #deleteWorkerBtn:hover {
    background-color: #dc2626;
  }

  #confirmModal {
    z-index: 110;
  }
  .modal-container.modal-hidden {
    display: none;
  }

  /* --- Worker Details & Calendar Styles --- */
  .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
  .calendar-header { font-weight: 700; font-size: 12px; color: var(--muted); padding-bottom: 8px; }
  .calendar-day { height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 14px; position: relative; }
  .calendar-day.not-in-month { color: var(--muted); opacity: 0.5; }
  .calendar-day.present { background-color: rgba(34, 197, 94, 0.2); color: #15803d; font-weight: 700; }
  .calendar-day.absent { background-color: rgba(239, 68, 68, 0.2); color: #b91c1c; font-weight: 700; }
  body.dark .calendar-day.present { color: #6ee7b7; }
  body.dark .calendar-day.absent { color: #fca5a5; }
  .settlement-card {
    background: linear-gradient(135deg, var(--accent), #d97706);
    color: white;
    border-radius: 12px;
    padding: 16px;
    margin: 20px 0;
  }

  .activity-log-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 8px; background: var(--bg); }
  .activity-log-item .icon { font-size: 16px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-left: 12px; }
  .activity-log-item .delete-activity { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 16px; }
  .activity-log-item .delete-activity:hover { color: #ef4444; }
  .activity-log-item .note { font-size: 12px; color: var(--muted); margin-top: 4px; padding-right: 44px; }

  .status-badge {
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    color: white;
    text-align: center;
  }

  @media print {
    body > * {
      display: none !important;
    }
    #printContainer, #printContainer * {
      display: block !important;
      visibility: visible !important;
    }
  }

  .toast-container {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 120;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    pointer-events: none;
  }
  .toast {
    background-color: #22c55e;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-weight: 700;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    animation: fadeInFromBottom 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  .toast.error { background-color: #ef4444; }

  .tab-card-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  .tab-card {
    padding: 12px 10px;
    border-radius: 12px;
    color: white;
    text-align: center;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    border: 3px solid transparent;
    opacity: 0.9;
  }
  .tab-card.active { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); border-color: var(--accent); opacity: 1; }
  .tab-card i { font-size: 20px; margin-bottom: 6px; }
  .tab-card span { font-weight: 700; font-size: 13px; display: block; }
  .tab-content { display: none; }
  .tab-content.active { display: block; animation: fadeIn .4s; }

  .professional-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  .professional-table th, .professional-table td { padding: 12px 10px; text-align: right; border-bottom: 1px solid var(--border-color); }
  .professional-table th { font-size: 13px; color: var(--muted); font-weight: 700; }
  .professional-table tbody tr { cursor: pointer; transition: background-color 0.2s ease; }
  .professional-table tbody tr:hover { background-color: var(--bg); }
  .professional-table .amount-col { font-weight: 700; text-align: left; }
  .professional-table .amount-col.positive { color: #10b981; }
  .professional-table .amount-col.negative { color: #ef4444; }
  .professional-table .icon-cell { width: 40px; text-align: center; }
  .professional-table .icon-cell i { color: var(--muted); }
  @media (max-width: 480px) {
    .professional-table .hide-on-mobile { display: none; }
  }
  /* *** إضافة: تنسيقات القائمة المنسدلة للمستخدم *** */
  .user-profile-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    background-color: var(--card);
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    border: 1px solid var(--border-color);
    width: 240px;
    z-index: 50;
    padding: 8px;
    animation: fadeInFromBottom 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  .user-profile-dropdown .user-info {
    padding: 8px 12px;
    margin-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
  }
  .user-profile-dropdown .user-info div {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  /* *** إضافة: تنسيقات جديدة لاختيار العامل كبطاقات *** */
  .worker-selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    max-height: 40vh;
    overflow-y: auto;
    padding: 4px;
  }
  .worker-selection-card {
    background: var(--bg);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 16px 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .worker-selection-card:hover {
    transform: translateY(-4px);
    border-color: var(--primary);
  }
  /* *** إضافة: تنسيقات جديدة لواجهة تفاصيل البلاغ *** */
  .report-type-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }
  .report-type-card {
    background: var(--bg);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 16px 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }
  .report-type-card.active {
    border-color: var(--primary);
    background-color: rgba(15, 118, 110, 0.1);
    color: var(--primary);
    transform: translateY(-2px);
  }
  .report-type-card i { font-size: 22px; }
  .report-type-card span { font-weight: 700; font-size: 14px; }
  .form-group .input-with-icon { position: relative; }
  .form-group .input-with-icon i { position: absolute; top: 50%; right: 12px; transform: translateY(-50%); color: var(--muted); }
  .form-group .input-with-icon input, .form-group .input-with-icon textarea { padding-right: 40px; }
</style>
<!-- *** إضافة: تنسيقات خاصة بميزة الملاحظات السريعة *** -->
<style>
  .notes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 16px;
  }
  .note-card {
    background: var(--card);
    border-radius: 8px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(2,6,23,.05);
    border-top: 4px solid var(--primary);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .note-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(2,6,23,.08);
  }
  .note-title { margin: 0 0 8px; font-weight: 700; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .note-content { margin: 0; font-size: 14px; color: var(--muted); line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 5; line-clamp: 5; -webkit-box-orient: vertical; overflow: hidden; min-height: 112px; }
  .note-footer { margin-top: 12px; padding-top: 8px; border-top: 1px solid var(--border-color); font-size: 12px; color: var(--muted); text-align: left; }
  #noteContent { resize: vertical; min-height: 120px; line-height: 1.6; }
  .color-swatches { display: flex; gap: 10px; margin-top: 8px; }
  .swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s ease, border-color 0.2s ease; }
  .swatch:hover { transform: scale(1.1); }
  .swatch.selected { border-color: var(--primary); box-shadow: 0 0 0 2px var(--card); }
  .add-note-container { max-width: 600px; margin: 0 auto 24px; background: var(--card); border-radius: 8px; box-shadow: 0 4px 12px rgba(2,6,23,.08); padding: 12px; }
  .add-note-container input, .add-note-container textarea { width: 100%; border: none; background: transparent; padding: 8px; font-size: 15px; color: var(--text-primary); font-family: 'Tajawal', sans-serif; }
  .add-note-container input:focus, .add-note-container textarea:focus { outline: none; }
  .add-note-container #newNoteTitle { font-weight: 700; font-size: 16px; } .add-note-container #newNoteContent { resize: none; min-height: 40px; } .new-note-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
</style>
<!-- *** إضافة: تنسيقات خاصة بالبلاغات المحمية *** -->
<style>
  .protected-report {
    position: relative;
    overflow: hidden;
  }
  .protected-report .report-content,
  .protected-report .report-footer {
    filter: blur(5px);
    pointer-events: none;
    opacity: 0.6;
  }
  .protected-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.1);
    color: var(--text-primary);
    text-align: center;
    font-weight: 700;
  }
</style>
<!-- *** إضافة: تنسيقات خاصة بنافذة الرسائل *** -->
<style>
  .message-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .message-item {
    background: var(--bg);
    padding: 12px;
    border-radius: 8px;
    border-right: 4px solid var(--primary);
  }
  .message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 8px;
  }
  .message-text {
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    flex-grow: 1;
  }
  .message-footer {
    margin-top: 12px;
    padding-top: 8px;
    border-top: 1px solid var(--border-color);
    font-size: 12px;
    color: var(--accent);
    font-weight: 700;
    text-align: left;
  }
</style>
</head>
<body>
  <div id="splash" class="splash" role="dialog" aria-hidden="false">
    <div class="splash-content">
        <div style="font-size:52px; margin-bottom:12px;"><i class="fas fa-users"></i></div>
        <h1 style="margin:0;font-size:24px;font-weight:800; letter-spacing: 1px;">My Decor Manager</h1>
        <p style="margin:8px 0 0;opacity:.9; font-size: 15px;">بوابة العامل</p>
        <div class="progress-bar">
            <div class="dot1"></div>
            <div class="dot2"></div>
            <div class="dot3"></div>
        </div>
    </div>
  </div>

  <div class="app-layout" id="appLayout">
    
    <nav class="main-nav" id="mainNav">
        <div class="nav-brand">
            <div class="logo" style="width:40px;height:40px;border-radius:10px;"><i class="fas fa-users"></i></div>
            <div>
              <div style="font-weight:800; font-size: 15px;">بوابة العامل</div>
            </div>
        </div>
        <div class="nav-item active" data-view="home">
            <i class="fas fa-tachometer-alt"></i>
            <span>الرئيسية</span>
        </div>
        <div class="nav-item" data-view="about">
            <i class="fas fa-info-circle"></i>
            <span>حول</span>
        </div>
        <div class="nav-item" data-view="workers">
            <i class="fas fa-users"></i>
            <span>العمال</span>
        </div>
        <div class="nav-item" data-view="settings">
            <i class="fas fa-cog"></i>
            <span>الاعدادات</span>
            <span class="notification-dot" id="settingsNotificationDot"></span>
        </div>
        <div class="sidebar-footer" style="display: none;">
            <button id="themeToggleSidebar" class="btn icon-btn ghost" title="تبديل الوضع"><i class="fas fa-moon"></i></button>
            <div style="position: relative; flex-grow: 1;"><button id="userProfileBtnSidebar" class="btn ghost" style="width: 100%; justify-content: flex-start; text-align: right; overflow: hidden;"><i id="userProfileIconSidebar" class="fas fa-sign-in-alt" style="margin-left: 8px;"></i><span id="userDisplayNameSidebar" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">تسجيل الدخول</span></button><div id="userProfileDropdownSidebar" class="user-profile-dropdown" style="display: none; bottom: 100%; top: auto; margin-bottom: 8px;"><div id="loggedInViewSidebar" style="display: none;"><div class="user-info"><div id="userDisplayNameDropdown" style="font-weight: 700;"></div><div id="userDisplayEmailDropdown" style="font-size: 13px; color: var(--muted);"></div></div><button id="logoutBtnSidebar" class="btn ghost" style="width: 100%; justify-content: flex-start; color: #ef4444; border-color: transparent; text-align: right;"><i class="fas fa-sign-out-alt" style="margin-left: 8px;"></i> تسجيل الخروج</button></div><div id="loggedOutViewSidebar" style="display: none;"><a href="worker-login.html" class="btn" style="text-decoration: none; width: 100%;"><i class="fas fa-sign-in-alt" style="margin-left: 8px;"></i> تسجيل الدخول</a></div></div></div>
        </div>
    </nav>
    
    <div class="app" id="app" aria-hidden="true" style="visibility: hidden;">
        <header class="app-header">
            <div class="brand">
                <div class="logo"><i class="fas fa-users"></i></div>
                <div>
                <div style="font-weight:800">بوابة العامل</div>
                <div style="font-size:13px;color:var(--muted)">My Decor Manager</div>
                </div>
            </div>
            <div style="display:flex;gap:8px;align-items:center; position: relative;">
                <button id="messagesBtn" class="btn icon-btn ghost" title="الرسائل الواردة">
                    <i class="fas fa-envelope"></i>
                    <span class="notification-dot" id="messagesNotificationDot"></span>
                </button>
                <button id="userProfileBtn" class="btn icon-btn ghost" title="الحساب">
                    <i id="userProfileIcon" class="fas fa-sign-in-alt"></i>
                </button>
                <div id="userProfileDropdown" class="user-profile-dropdown" style="display: none;">
                    <!-- Logged In View -->
                    <div id="loggedInView" style="display: none;">
                        <div class="user-info">
                            <div id="userDisplayName" style="font-weight: 700;">جاري التحميل...</div>
                            <div id="userDisplayEmail" style="font-size: 13px; color: var(--muted);"></div>
                        </div>
                        <button id="logoutBtn" class="btn ghost" style="width: 100%; justify-content: flex-start; color: #ef4444; border-color: transparent; text-align: right;">
                            <i class="fas fa-sign-out-alt" style="margin-left: 8px;"></i> تسجيل الخروج
                        </button>
                    </div>
                    <!-- Logged Out View -->
                    <div id="loggedOutView" style="display: none;">
                        <a href="worker-login.html" class="btn" style="text-decoration: none; width: 100%;"><i class="fas fa-sign-in-alt" style="margin-left: 8px;"></i> تسجيل الدخول</a>
                    </div>
                </div>
                <button id="themeToggleHeader" class="btn icon-btn ghost" title="تبديل الوضع"><i class="fas fa-moon"></i></button>
            </div>
        </header>

        <main id="mainContent">
        </main>
    </div>

  </div>

  <!-- Modal for adding/editing workers -->
  <div id="workerModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="workerModalTitle">إضافة عامل جديد</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="workerForm">
                  <input type="hidden" id="workerId">
                  <input type="hidden" id="workerImageDataBase64">

                  <div class="form-group" style="text-align: center; position: relative;">
                      <img id="workerImagePreview" src="" alt="صورة العامل" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color); display: none; margin: 0 auto 10px;">
                      <button type="button" id="workerImageRemoveBtn" title="إزالة الصورة" style="position: absolute; top: -5px; left: 50%; transform: translateX(40px); width: 28px; height: 28px; border-radius: 50%; background: #ef4444; color: white; border: 2px solid var(--card); font-size: 14px; display: none; cursor: pointer; padding: 0; line-height: 1;">&times;</button>

                      <div id="workerImagePlaceholder" class="icon" style="width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg,#f97316,#f59e0b); font-size: 40px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                          <i class="fas fa-user"></i>
                      </div>
                      <input type="file" id="workerImageInput" accept="image/*" style="display: none;">
                      <button type="button" id="workerImageUploadBtn" class="btn ghost" style="padding: 6px 12px; font-size: 13px;">اختر صورة</button>
                  </div>

                  <div class="form-group">
                      <label for="workerName">اسم العامل</label>
                      <input type="text" id="workerName" required>
                  </div>
                  <div class="form-group">
                      <label for="workerPhone">رقم الهاتف</label>
                      <input type="tel" id="workerPhone">
                  </div>
                  <div class="form-group">
                      <label for="workerDailyRate">الأجرة اليومية الافتراضية (د.ج)</label>
                      <input type="number" id="workerDailyRate" required>
                  </div>

                  <div class="form-actions">
                      <button type="submit" class="btn">حفظ</button>
                      <button type="button" class="btn" id="deleteWorkerBtn" style="display: none; background-color: #ef4444;">حذف</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لإرسال بلاغ للمدير *** -->
  <div id="reportModal" class="modal-container modal-hidden">
      <div class="modal-backdrop" data-action="close-modal"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="reportModalTitle">إرسال بلاغ للمدير</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <!-- *** تعديل: تحويل النموذج إلى نظام خطوات *** -->
              <form id="reportForm">
                  <input type="hidden" id="reportForWorkerId">
                  <input type="hidden" id="reportForWorkerName">

                  <!-- الخطوة 1: اختيار العامل -->
                  <div id="reportStep1" class="report-step">
                        <!-- *** تحسين: استبدال القائمة المنسدلة بشبكة بطاقات *** -->
                        <div class="form-group">
                            <label>اختر العامل الذي تريد التبليغ عنه</label>
                            <div id="workerSelectionContainer" class="worker-selection-grid">
                                <!-- سيتم حقن بطاقات العمال هنا -->
                            </div>
                        </div>
                  </div>

                  <!-- الخطوة 2: التحقق من PIN (إذا لزم الأمر) -->
                  <div id="reportStep2" class="report-step" style="display: none;">
                      <p>الرجاء إدخال رمز PIN للعامل <strong id="reportPinWorkerName"></strong> للمتابعة.</p>
                      <div class="form-group">
                          <input type="password" id="reportPinInput" required pattern="\d{4}" maxlength="4" style="text-align: center; font-size: 24px; letter-spacing: 10px;">
                      </div>
                      <div class="form-actions">
                          <button type="button" id="reportBackToStep1" class="btn ghost">رجوع</button>
                          <button type="button" id="reportVerifyPin" class="btn">تحقق</button>
                      </div>
                  </div>

                  <!-- الخطوة 3: تفاصيل البلاغ -->
                  <div id="reportStep3" class="report-step" style="display: none;">
                      <!-- *** تحسين: استبدال القائمة المنسدلة ببطاقات اختيار *** -->
                      <div class="form-group">
                          <label>نوع البلاغ</label>
                          <div class="report-type-selector">
                              <div class="report-type-card active" data-type="غياب">
                                  <i class="fas fa-calendar-times"></i>
                                  <span>غياب</span>
                              </div>
                              <div class="report-type-card" data-type="طلب إجازة">
                                  <i class="fas fa-umbrella-beach"></i>
                                  <span>طلب إجازة</span>
                              </div>
                              <div class="report-type-card" data-type="شكوى">
                                  <i class="fas fa-gavel"></i>
                                  <span>شكوى</span>
                              </div>
                          </div>
                          <input type="hidden" id="reportType" value="غياب">
                      </div>
                      <!-- *** إضافة: حقل تاريخ واحد للبلاغات العادية *** -->
                      <div class="form-group" id="reportSingleDateGroup">
                          <label for="reportDate">تاريخ البلاغ</label>
                          <div class="input-with-icon">
                              <i class="fas fa-calendar-day"></i>
                              <input type="date" id="reportDate" required style="width: 100%;">
                          </div>
                      </div>
                      <!-- *** إضافة: حقول فترة الإجازة (مخفية افتراضياً) *** -->
                      <div class="form-group" id="reportDateRangeGroup" style="display: none;">
                          <label>فترة الإجازة</label>
                          <!-- *** تعديل: إضافة تسميات "من" و "إلى" لتوضيح الحقول *** -->
                          <div style="display: flex; gap: 10px; align-items: flex-start;">
                              <div style="flex: 1;">
                                  <label for="reportStartDate" style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">من</label>
                                  <input type="date" id="reportStartDate" title="من تاريخ" style="width: 100%;">
                              </div>
                              <div style="flex: 1;">
                                  <label for="reportEndDate" style="font-size: 13px; color: var(--muted); margin-bottom: 4px;">إلى</label>
                                  <input type="date" id="reportEndDate" title="إلى تاريخ" style="width: 100%;">
                              </div>
                          </div>
                      </div>
                      <div class="form-group">
                          <label for="reportNote">الملاحظة</label>
                          <div class="input-with-icon">
                              <i class="fas fa-pencil-alt"></i>
                              <textarea id="reportNote" rows="4" required placeholder="اشرح سبب البلاغ..."></textarea>
                          </div>
                      </div>
                      <div class="form-actions"><button type="button" id="submitReportBtn" class="btn" style="width: 100%; padding: 12px; font-size: 16px;"><i class="fas fa-paper-plane" style="margin-left: 8px;"></i> إرسال البلاغ</button></div>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for adding attendance/payment -->
  <div id="activityModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="activityModalTitle">إضافة نشاط</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="activityForm">
                  <input type="hidden" id="activityWorkerId">
                  <input type="hidden" id="activityType">
                  <div class="form-group">
                      <label for="activityDate">التاريخ</label>
                      <input type="date" id="activityDate" required>
                  </div>
                  <div id="attendanceRateGroup" class="form-group" style="display: none;">
                      <label for="attendanceDailyRate">أجرة هذا اليوم (د.ج)</label>
                      <input type="number" id="attendanceDailyRate" placeholder="تُستخدم الأجرة الافتراضية إذا ترك فارغاً">
                  </div>
                  <div id="paymentAmountGroup" class="form-group" style="display: none;">
                      <label for="paymentAmount">المبلغ المدفوع (د.ج)</label>
                      <input type="number" id="paymentAmount" placeholder="مثال: 5000">
                  </div>
                  <div id="activityNoteGroup" class="form-group" style="display: none;">
                      <label for="activityNote">ملاحظة (اختياري)</label>
                      <input type="text" id="activityNote" placeholder="مثال: سلفة أسبوعية">
                  </div>
                  <div class="form-actions"><button type="submit" class="btn">حفظ</button></div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal for full activity log -->
  <div id="activityLogModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
              <h3>السجل الكامل للأنشطة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <div id="fullActivityLogContent">
                  <!-- Full log will be injected here -->
              </div>
          </div>
      </div>
  </div>

  <!-- Modal for attendance confirmation -->
  <div id="attendanceConfirmModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 360px;">
          <div class="modal-header">
              <h3>تأكيد حالة اليوم</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body" style="text-align: center;">
              <p style="margin-top:0; margin-bottom: 20px;">الرجاء تحديد حالة العامل لتاريخ <strong id="confirmDate"></strong>:</p>
              <div class="form-actions" style="justify-content: center;">
                  <button type="button" class="btn" id="confirmPresentBtn" style="background-color: #10b981; flex: 1;"><i class="fas fa-check" style="margin-left: 6px;"></i> حضور</button>
                  <button type="button" class="btn" id="confirmAbsentBtn" style="background-color: #ef4444; flex: 1;"><i class="fas fa-times" style="margin-left: 6px;"></i> غياب</button>
              </div>
          </div>
      </div>
  </div>

  <div id="confirmModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 380px;">
          <div class="modal-header">
              <h3 id="confirmModalTitle">تأكيد الحذف</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body" style="text-align: center;">
              <div style="font-size: 48px; color: #ef4444; margin-bottom: 16px;"><i class="fas fa-exclamation-triangle"></i></div>
              <p id="confirmModalMessage" style="margin-top:0; margin-bottom: 20px; font-size: 15px; line-height: 1.6;"></p>
              <div class="form-actions" style="justify-content: center;">
                  <button type="button" class="btn" id="confirmModalCancelBtn" style="background-color: var(--muted);">إلغاء</button>
                  <button type="button" class="btn" id="confirmModalConfirmBtn">نعم</button>
              </div>
          </div>
      </div>
  </div>

  <div id="debtModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="debtModalTitle">إضافة دين جديد</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="debtForm">
                  <input type="hidden" id="debtId">
                  <div class="form-group">
                      <label for="debtPerson">اسم الشخص</label>
                      <input type="text" id="debtPerson" required placeholder="مثال: أحمد علي">
                  </div>
                  <div class="form-group">
                      <label for="debtAmount">المبلغ (د.ج)</label>
                      <input type="number" id="debtAmount" required>
                  </div>
                  <div class="form-group">
                      <label for="debtDueDate">تاريخ الاستحقاق (اختياري)</label>
                      <input type="date" id="debtDueDate">
                  </div>
                  <div class="form-group"><label for="debtNotes">ملاحظات</label><textarea id="debtNotes" rows="3" placeholder="تفاصيل إضافية عن الدين..."></textarea></div><div class="form-actions"><button type="submit" class="btn">حفظ</button><button type="button" class="btn" id="deleteDebtBtn" style="display: none; background-color: #ef4444;">حذف</button></div>
              </form>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة للتحقق من PIN لعرض البلاغ *** -->
  <div id="reportPinVerifyModal" class="modal-container modal-hidden">
    <div class="modal-backdrop" data-action="close-modal"></div>
    <div class="modal-content" style="max-width: 360px;">
        <div class="modal-header">
            <h3>التحقق من الهوية</h3>
            <button class="close-btn" data-action="close-modal">&times;</button>
        </div>
        <div class="modal-body" style="text-align: center;">
            <p style="margin-top:0; margin-bottom: 20px;">لعرض هذا البلاغ، الرجاء إدخال رمز PIN الخاص بالعامل <strong id="verifyPinWorkerName"></strong>.</p>
            <form id="reportPinVerifyForm">
                <input type="hidden" id="verifyPinReportId">
                <input type="hidden" id="verifyPinWorkerId">
                <div class="form-group">
                    <input type="password" id="verifyPinInput" required pattern="\d{4}" maxlength="4" style="text-align: center; font-size: 24px; letter-spacing: 10px;">
                </div>
                <div class="form-actions" style="justify-content: center;">
                    <button type="submit" class="btn" style="flex: 1;">عرض البلاغ</button>
                </div>
            </form>
        </div>
    </div>
  </div>


  <!-- *** إضافة: نافذة منبثقة لإضافة المشتريات *** -->
  <div id="purchaseModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="purchaseModalTitle">إضافة شراء جديد</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="purchaseForm">
                  <!-- *** إضافة: حقل جديد لإدخال اسم العامل *** -->
                  <div class="form-group">
                      <label for="purchaseWorkerName">اسم العامل</label>
                      <input type="text" id="purchaseWorkerName" required placeholder="أدخل اسم العامل الذي قام بالشراء">
                  </div>
                  <div class="form-group">
                      <label for="purchaseDescription">وصف الشراء</label>
                      <input type="text" id="purchaseDescription" required placeholder="مثال: شراء دهانات ساتيني">
                  </div>
                  <div class="form-group">
                      <label for="purchaseAmount">المبلغ (د.ج)</label>
                      <input type="number" id="purchaseAmount" required>
                  </div>
                  <div class="form-group">
                      <label for="purchaseDate">التاريخ</label>
                      <input type="date" id="purchaseDate" required>
                  </div>
                  <div class="form-group"><label for="purchaseNotes">ملاحظات (اختياري)</label><textarea id="purchaseNotes" rows="3" placeholder="تفاصيل إضافية..."></textarea></div>
                  <div class="form-actions"><button type="submit" class="btn">إرسال للمراجعة</button></div>
              </form>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة احترافية لعرض تفاصيل الشراء *** -->
  <div id="purchaseDetailsModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 420px;">
          <div class="modal-header">
              <h3>تفاصيل السجل</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body" id="purchaseDetailsContent" style="line-height: 1.7;">
              <!-- Details will be injected here by JavaScript -->
          </div>
          <div id="purchaseDetailsFooter" class="form-actions" style="padding: 16px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end;">
              <!-- Action buttons (like delete and close) will be injected here -->
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لعرض الرسائل الواردة *** -->
  <div id="messagesModal" class="modal-container modal-hidden">
      <div class="modal-backdrop" data-action="close-modal"></div>
      <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
              <h3>الرسائل الواردة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <div id="messagesListContainer" class="message-list">
                  <!-- Messages will be injected here -->
              </div>
          </div>
      </div>
  </div>

  <!-- *** إضافة: نافذة منبثقة لإضافة/تعديل الملاحظات *** -->
  <div id="noteModal" class="modal-container modal-hidden">
      <div class="modal-backdrop" data-action="close-modal"></div>
      <div class="modal-content">
          <div class="modal-header">
              <h3 id="noteModalTitle">إضافة ملاحظة جديدة</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body">
              <form id="noteForm">
                  <input type="hidden" id="noteId">
                  <div class="form-group">
                      <label for="noteTitle">العنوان</label>
                      <input type="text" id="noteTitle" placeholder="عنوان الملاحظة...">
                  </div>
                  <div class="form-group">
                      <label for="noteContent">المحتوى</label>
                      <textarea id="noteContent" rows="6" placeholder="اكتب ملاحظتك هنا..."></textarea>
                  </div>
                  <div class="form-group">
                      <label>اللون</label>
                      <div class="color-swatches">
                          <div class="swatch selected" data-color="#3b82f6" style="background: #3b82f6;"></div>
                          <div class="swatch" data-color="#10b981" style="background: #10b981;"></div>
                          <div class="swatch" data-color="#f59e0b" style="background: #f59e0b;"></div>
                          <div class="swatch" data-color="#ef4444" style="background: #ef4444;"></div>
                          <div class="swatch" data-color="#64748b" style="background: #64748b;"></div>
                      </div>
                  </div>
                  <div class="form-actions">
                      <button type="submit" class="btn">حفظ</button>
                      <button type="button" class="btn" id="deleteNoteBtn" style="display: none; background-color: #ef4444;">حذف</button>
                  </div>
              </form>
          </div>
      </div>
  </div>





  <div id="printContainer" class="print-only" style="display: none;"></div>

  <div id="toastContainer" class="toast-container"></div>

<script>
function getThemeColors() {
    const computedStyle = getComputedStyle(document.documentElement);
    return {
        '--primary': computedStyle.getPropertyValue('--primary'),
        '--bg': computedStyle.getPropertyValue('--bg'),
        '--card': computedStyle.getPropertyValue('--card'),
        '--text-primary': computedStyle.getPropertyValue('--text-primary'),
        '--border-color': computedStyle.getPropertyValue('--border-color')
    };
}
  const firebaseConfig = {
      apiKey: "AIzaSyC52e_whkQh-vwgdwuuzl4wMpVxILXGkSQ",
      authDomain: "shoes-manager-pro.firebaseapp.com",
      projectId: "shoes-manager-pro",
      storageBucket: "shoes-manager-pro.firebasestorage.app",
      messagingSenderId: "951149272003",
      appId: "1:951149272003:web:85d665da99166298047b76"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const firestore = firebase.firestore();

  const db = new Dexie('decorManagerDB_worker');
  // *** إصلاح: زيادة رقم الإصدار إلى 26 لحل مشكلة "Upgrade blocked" بعد إضافة جدول الملاحظات ***
  db.version(26).stores({
      workers: '++id, name, pin, settlements',
      projects: '++id, name, status, builderName',
      suppliers: '++id, name',
      debts: '++id, type, dueDate',
      expenses: '++id, date, projectId, workerId, supplierId, category, paymentStatus',
      // *** إصلاح: استخدام firestoreId كمفتاح أساسي وتحديد الفهارس اللازمة ***
      purchases: 'firestoreId, workerId, status',
      app_settings: 'key',
      messages: '++id, timestamp',
      notes: '++id, updatedAt', // *** إضافة: جدول لتخزين الملاحظات ***
      reports: 'firestoreId, workerId, status, date' // *** إضافة: جدول للبلاغات ***
  });

  let isDbOpen = false;

  // *** إضافة: متغير لتخزين دوال إلغاء الاشتراك في Firestore لمنع التكرار ***
  let firestoreUnsubscribeFunctions = [];

  function getOrCreateDeviceId() {
    let deviceId = localStorage.getItem('appDeviceId_worker');
    if (!deviceId) {
        deviceId = `device_worker_${Date.now()}_${Math.random()}`;
        localStorage.setItem('appDeviceId_worker', deviceId);
    }
    return deviceId;
  }
  const deviceIdentifier = getOrCreateDeviceId();

  let state = {
    previousView: null,
    currentView: { name: 'home', params: {} },
    projects: [],
    workers: [],
    notes: [], // *** إضافة: حالة لتخزين الملاحظات ***
    suppliers: [],
    debts: [],
    expenses: [],
    hasNewSync: false, // *** إضافة: حالة لتتبع وجود مزامنة جديدة ***
    purchases: [], // *** إضافة: حالة لتخزين المشتريات ***
    isSubscribed: false, // *** إضافة: حالة لتتبع اشتراك المدير ***
    reports: [], // *** إصلاح: تهيئة مصفوفة البلاغات لمنع الخطأ ***
    messages: [], // *** إضافة: حالة لتخزين الرسائل ***
    hasNewMessages: false, // *** إضافة: حالة لتتبع الرسائل الجديدة ***
    showAllMessages: false, // *** إضافة: حالة لعرض كل الرسائل أو بعضها ***
    tempAttendanceData: {},
    hasNewReportUpdates: false, // *** إضافة: حالة لتتبع تحديثات البلاغات ***
  };

  const appModules = [
    {
      key: 'workers',
      title: 'سجل العمال',
      description: 'قائمة العمال وأرصدتهم الحالية',
      icon: 'fa-users',
      color: 'linear-gradient(135deg,#f97316,#f59e0b)',
      hasNotification: () => state.hasNewSync
    },
    // *** إضافة: وحدة جديدة لإرسال البلاغات ***
    {
      key: 'reports', // *** تعديل: تغيير المفتاح لينتقل إلى واجهة البلاغات
      title: 'تبليغ المدير',
      description: 'إرسال بلاغ عن غياب، تأخير، أو ملاحظة',
      icon: 'fa-flag', // *** إضافة: دالة التحقق من وجود تحديثات جديدة للبلاغات ***
      hasNotification: () => state.hasNewReportUpdates,
      color: 'linear-gradient(135deg,#3b82f6,#2563eb)'
    },
    // *** إضافة: وحدة جديدة للملاحظات السريعة ***
    {
      key: 'notes',
      title: 'ملاحظات سريعة',
      description: 'لتسجيل أفكارك وملاحظاتك الشخصية',
      icon: 'fa-sticky-note',
      color: 'linear-gradient(135deg,#ec4899,#d946ef)'
    },
    { key: 'purchases', title: 'سجل المشتريات', description: 'تسجيل مشتريات المواد والأدوات', icon: 'fa-shopping-cart', color: 'linear-gradient(135deg,#8b5cf6,#6366f1)', hasNotification: () => false },
  ];

  const themes = {
    'default-light': { name: 'افتراضي فاتح', type: 'light', colors: { '--primary': '#0f766e', '--accent': '#f59e0b', '--bg': '#f8fafc', '--card': '#ffffff' } },
    'ocean-light': { name: 'محيط فاتح', type: 'light', colors: { '--primary': '#3b82f6', '--accent': '#f43f5e', '--bg': '#f0f9ff', '--card': '#ffffff' } },
    'forest-light': { name: 'غابة فاتحة', type: 'light', colors: { '--primary': '#16a34a', '--accent': '#d97706', '--bg': '#f0fdf4', '--card': '#ffffff' } },
    'sunset-light': { name: 'غروب فاتح', type: 'light', colors: { '--primary': '#f97316', '--accent': '#7c3aed', '--bg': '#fff7ed', '--card': '#ffffff' } },
    'neutral-light': { name: 'محايد فاتح', type: 'light', colors: { '--primary': '#475569', '--accent': '#0f766e', '--bg': '#f1f5f9', '--card': '#ffffff' } },
    'default-dark': { name: 'افتراضي داكن', type: 'dark', colors: { '--primary': '#0d9488', '--accent': '#f59e0b', '--bg': '#071026', '--card': '#0b1220' } },
    'midnight-dark': { name: 'منتصف الليل', type: 'dark', colors: { '--primary': '#38bdf8', '--accent': '#f472b6', '--bg': '#020617', '--card': '#0f172a' } },
    'emerald-dark': { name: 'زمردي داكن', type: 'dark', colors: { '--primary': '#34d399', '--accent': '#facc15', '--bg': '#061e14', '--card': 'rgb(13, 39, 28)' } },
    'purple-dark': { name: 'بنفسجي داكن', type: 'dark', colors: { '--primary': '#a78bfa', '--accent': '#fb923c', '--bg': '#1e1b4b', '--card': '#312e81' } },
    'slate-dark': { name: 'أردوازي داكن', type: 'dark', colors: { '--primary': '#cbd5e1', '--accent': '#0ea5e9', '--bg': '#0f172a', '--card': '#1e293b' } },
  };
  const splash = document.getElementById('splash');
  const app = document.getElementById('app');
  const themeToggleHeader = document.getElementById('themeToggleHeader');
  const mainContent = document.getElementById('mainContent');
  const mainNav = document.getElementById('mainNav');
  
  async function loadState() {
      state.workers = await db.workers.toArray();
      state.projects = await db.projects.toArray();
      state.notes = await db.notes.toArray(); // *** إضافة: تحميل الملاحظات ***
      state.suppliers = await db.suppliers.toArray();
      state.debts = await db.debts.toArray();
      state.expenses = await db.expenses.toArray();
      state.purchases = await db.purchases.toArray();
      state.messages = await db.messages.toArray();
      state.currentView = { name: 'home', params: {} };
      state.reports = await db.reports.toArray(); // *** إصلاح: تحميل البلاغات المحفوظة عند بدء التشغيل ***
  }

  async function applyThemeSet(themeName) {
    const theme = themes[themeName];
    if (!theme) return;

    document.body.classList.toggle('dark', theme.type === 'dark');

    const themeToggleHeader = document.getElementById('themeToggleHeader');
    if (themeToggleHeader) {
        themeToggleHeader.innerHTML = theme.type === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    }

    const root = document.documentElement;
    Object.entries(theme.colors).forEach(([key, value]) => {
        root.style.setProperty(key, value);
    });

    await db.app_settings.put({ key: 'selected_theme', value: themeName });
    state.selected_theme = themeName;
  }

  async function toggleTheme() {
    const currentThemeName = state.selected_theme || 'default-light';
    const currentTheme = themes[currentThemeName];
    const newThemeName = (currentTheme.type === 'light') ? 'default-dark' : 'default-light';
    await applyThemeSet(newThemeName);
    if (state.currentView.name === 'themes') renderView('themes');
  }
  
  async function renderView(viewName, params = {}) {
    if (!isDbOpen) {
        setTimeout(() => renderView(viewName, params), 100);
        return;
    }

    state.previousView = state.currentView;
    state.currentView = { name: viewName, params };

    const currentView = mainContent.querySelector('.view-container');
    const transitionDuration = 250;

    try {
        state.workers = await db.workers.toArray();
        state.projects = await db.projects.toArray();
        state.notes = await db.notes.toArray(); // *** إضافة: جلب الملاحظات ***
        state.purchases = await db.purchases.toArray();
        state.suppliers = await db.suppliers.toArray();
        state.debts = await db.debts.toArray();
        state.expenses = await db.expenses.toArray();
        state.messages = await db.messages.toArray();
    } catch (error) {
        console.error("Error fetching data in renderView:", error);
        mainContent.innerHTML = `<div class="view-container"><p style="color: #ef4444; text-align: center;">حدث خطأ أثناء تحميل بيانات الواجهة.</p></div>`;
        return;
    }

    const renderNewContent = async () => {
        mainContent.innerHTML = '';
        let content = '';

        switch(viewName) {
            case 'home':          content = getHomeView(); break; 
            case 'workers':       content = getWorkersView(false); break; // Pass false to disable add/edit
            case 'worker-details': content = getWorkerDetailsView(params.id); break;
            case 'settings':      content = getSettingsView(); break;
            case 'expenses':      content = getExpensesView(); break;
            case 'themes':        content = getThemesView(); break;
            case 'about':         content = getAboutView(); break;
            case 'purchases':     content = getPurchasesView(); break; // *** إضافة: واجهة سجل المشتريات ***
            case 'notes':         content = getNotesView(); break; // *** إضافة: واجهة الملاحظات ***
            case 'clear_cache':   content = getClearCacheView(); break; // *** إضافة: واجهة مسح الكاش ***
            case 'reports':       content = getReportsView(); break; // *** إضافة: واجهة جديدة للبلاغات
            default:              content = `<h3>View Not Found: ${viewName}</h3>`;
        } 
        
        mainContent.innerHTML = `<div class="view-container">${content}</div>`;
        
        if (viewName === 'clear_cache') document.getElementById('clearCacheBtn')?.addEventListener('click', handleClearCache);
        // *** إضافة: إخفاء إشعار البلاغات عند زيارة الصفحة ***
        if (viewName === 'reports') {
            state.hasNewReportUpdates = false;
            updateNotificationDots(); // تحديث الواجهة لإزالة النقطة فوراً
        }

        if (viewName === 'settings') {
            document.getElementById('navigateToThemes')?.addEventListener('click', () => renderView('themes'));
            document.getElementById('navigateToClearCache')?.addEventListener('click', () => renderView('clear_cache'));
        }
        if (viewName === 'themes') {
            mainContent.querySelectorAll('.theme-card').forEach(card => card.addEventListener('click', async (e) => {
                await applyThemeSet(e.currentTarget.dataset.theme);
                renderView('themes');
            }));
        }
        // *** إضافة: ربط زر الإضافة العائم في واجهة البلاغات ***
        if (viewName === 'reports') {
            document.getElementById('openReportModalBtn')?.addEventListener('click', openReportModal);
        }
        if (viewName === 'workers') {
            document.getElementById('refreshWorkersBtn')?.addEventListener('click', fetchLatestWorkLogs);
            // *** إضافة: تطبيق تأثير التوهج على زر التحديث عند وجود مزامنة جديدة ***
            const refreshBtn = document.getElementById('refreshWorkersBtn');
            if (refreshBtn && state.hasNewSync) {
                refreshBtn.classList.add('glow');
            }

            mainContent.querySelectorAll('[data-action="view-worker"]').forEach(card => card.addEventListener('click', async (e) => {
                const workerId = parseInt(e.currentTarget.dataset.id);
                const worker = state.workers.find(w => w.id === workerId);
                if (worker && worker.pin) {
                    openWorkerPinModal(workerId);
                } else {
                    renderView('worker-details', { id: workerId });
                }
            }));
        }
        // Attach purchase delete listeners when on purchases view
        if (viewName === 'purchases') {
            // Progressively attach to currently rendered delete buttons
            document.querySelectorAll('.purchase-delete-btn').forEach(btn => {
                btn.removeEventListener('click', handlePurchaseDeleteClick);
                btn.addEventListener('click', async (e) => {
                    // Show a confirm modal before deleting
                    const firestoreId = btn.dataset.id;
                    openConfirmModal('هل أنت متأكد من حذف سجل الشراء هذا نهائياً؟', async () => {
                        closeConfirmModal();
                        await executePurchaseDelete(btn); // *** إصلاح: استدعاء الدالة الجديدة التي لا تتوقع كائن حدث ***
                    });
                });
            });
            // Attach click listeners to open details modal when clicking an item
            document.querySelectorAll('[data-action="view-purchase-details"]').forEach(item => {
                item.removeEventListener('click', item._viewPurchaseHandler);
                const handler = (e) => {
                    const id = item.dataset.firestoreId;
                    if (id) openPurchaseDetailsModal(id);
                };
                item._viewPurchaseHandler = handler;

                item.addEventListener('click', handler);
            });
        }
        // *** إضافة: ربط أحداث واجهة الملاحظات ***
        if (viewName === 'notes') {
            mainContent.querySelectorAll('.note-card').forEach(card => card.addEventListener('click', (e) => openNoteModal(parseInt(e.currentTarget.dataset.id))));
            setupInlineNoteForm();
        }
        if (viewName === 'worker-details') {
            document.getElementById('backToWorkers')?.addEventListener('click', () => renderView('workers'));
            const prevMonthBtn = document.querySelector('button[data-action="prev-month"]');
            if(prevMonthBtn) {
                prevMonthBtn.addEventListener('click', (e) => {
                    renderView('worker-details', {id: parseInt(e.currentTarget.dataset.id), month: parseInt(e.currentTarget.dataset.month), year: parseInt(e.currentTarget.dataset.year)});
                });
            }
            const nextMonthBtn = document.querySelector('button[data-action="next-month"]');
            if(nextMonthBtn) {
                nextMonthBtn.addEventListener('click', (e) => {
                    renderView('worker-details', {id: parseInt(e.currentTarget.dataset.id), month: parseInt(e.currentTarget.dataset.month), year: parseInt(e.currentTarget.dataset.year)});
                });
            }
        }
    };

    const previouslyActiveNavItem = mainNav.querySelector('.nav-item.active');
    const isNewView = !previouslyActiveNavItem || previouslyActiveNavItem.dataset.view !== viewName;

    const isMainNavItem = [...mainNav.querySelectorAll('.nav-item')].some(item => item.dataset.view === viewName);
    if(isMainNavItem) {
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.view === viewName);
        });
    }


    if (currentView && isNewView) {
        currentView.classList.add('is-exiting');
        setTimeout(renderNewContent, transitionDuration);
    } else {
        renderNewContent();
    }
  }

  function showToast(message) {
      showCustomToast(message, 'success');
  }

  function showCustomToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
      
      if (type === 'error') toast.classList.add('error');
      container.appendChild(toast);

      setTimeout(() => { toast.remove(); }, 3000);
  }
  function createCardHTML(m) {
    const shouldShowDot = m.hasNotification ? m.hasNotification() : false;
    return `
      <div class="card" data-key="${m.key}">
        <span class="notification-dot" id="notification-dot-${m.key}" style="display: ${shouldShowDot ? 'block' : 'none'};"></span>
        <div class="icon" style="background:${m.color}"><i class="fas ${m.icon}"></i></div>
        <div>
          <div style="font-weight:900; font-size: 16px;">${m.title}</div>
          <div style="color:var(--muted); font-size:13px; margin-top: 4px;">${m.description}</div>
        </div>
      </div>
    `;
  }

  /**
   * *** إصلاح: إضافة الدالة المساعدة المفقودة لتوحيد صيغ التواريخ ***
   * تتعامل هذه الدالة مع أنواع التواريخ المختلفة (Firestore Timestamp, JS Date, etc.)
   * @param {any} ts - الطابع الزمني المراد توحيده
   * @returns {number} - الطابع الزمني بصيغة ميلي ثانية
   */
  function normalizeTimestamp(ts) {
      if (!ts) return 0;
      // إذا كان طابع زمني من Firestore
      if (typeof ts.toDate === 'function') return ts.toDate().getTime();
      // إذا كان كائن تاريخ JavaScript
      if (ts instanceof Date) return ts.getTime();
      // إذا كان رقم (timestamp)
      if (typeof ts === 'number') return ts;
      // محاولة تحويله كنص
      const parsed = Date.parse(ts);
      return isNaN(parsed) ? 0 : parsed;
  }

  function getHomeView() {
    const activeWorkers = state.workers.length;
    const mainGridHTML = appModules.map(createCardHTML).join('');

    return `
      <section class="hero" aria-label="لوحة التحكم">
        <div>
          <h2 style="margin:0;font-weight:800">أهلاً بك</h2>
          <p style="margin:6px 0 0;opacity:.95">هذه هي لوحة التحكم الخاصة بك.</p>
        </div>
        <div class="kpis" style="margin-top:12px">
            <div class="kpi">
                <div style="font-size:18px;font-weight:800">${activeWorkers}</div>
                <div style="font-size:12px;opacity:.9">إجمالي العمال</div>
            </div>
        </div>
      </section>
      <div class="grid-cards">${mainGridHTML}</div>
    `;
  }
  
  function getWorkersView(allowActions = false) {
     const workersListHTML = state.workers && state.workers.length > 0
        ? state.workers.map(worker => {
            const { totalDue, totalPaid } = calculateWorkerFinancials(worker);
            const balance = totalDue - totalPaid;
            const workerColor = 'linear-gradient(135deg,#f97316,#f59e0b)';
            return `
            <div class="card" data-action="view-worker" data-id="${worker.id}" style="flex-direction: row; justify-content: space-between; align-items: center; text-align: right; margin-bottom: 12px; padding: 12px 16px;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    ${worker.imageUrl
                        ? `<img src="${worker.imageUrl}" alt="${worker.name}" style="width:48px; height:48px; border-radius: 50%; object-fit: cover;">`
                        : `<div class="icon" style="width:48px; height:48px; background: ${workerColor}; font-size: 20px; margin-bottom: 0;"><i class="fas fa-user"></i></div>`
                    }
                    <div>
                        <div style="font-weight: 700;">${worker.name}</div>
                        <div style="font-size: 13px; color: var(--muted);">${worker.phone || 'لا يوجد رقم هاتف'}</div>
                    </div>
                </div>
                <div style="text-align: left;">
                    <div style="font-weight: 700; font-size: 15px; color: ${balance > 0 ? '#ef4444' : 'var(--primary)'};">${balance.toLocaleString()} د.ج</div>
                    <div style="font-size: 12px; color: var(--muted);">الرصيد الحالي</div>
                </div>
            </div>
        `}).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم يتم إضافة أي عمال بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">سجل العمال</h3>
            <div style="display: flex; gap: 8px;">
                <button id="refreshWorkersBtn" class="btn" title="تحديث البيانات" style="background-color: #3b82f6;"><i class="fas fa-sync-alt"></i> تحديث</button>
            </div>
        </div>
        ${workersListHTML}
    `;
  }

  function getWorkerDetailsView(workerId) {
    const worker = state.workers.find(w => w.id === workerId);
    if (!worker) return `<p>لم يتم العثور على العامل.</p><button onclick="renderView('workers')">العودة</button>`;

    // For calendar
    const today = new Date();
    const currentMonth = state.currentView.params.month === undefined ? today.getMonth() : state.currentView.params.month;
    const currentYear = state.currentView.params.year === undefined ? today.getFullYear() : state.currentView.params.year;

    const { totalDue, totalPaid } = calculateWorkerFinancials(worker, currentYear, currentMonth);
    const balance = totalDue - totalPaid;

    const prevMonth = new Date(currentYear, currentMonth - 1, 1);
    const nextMonth = new Date(currentYear, currentMonth + 1, 1);

    // --- Settlement Card Logic ---
    const settlementKey = `${currentYear}-${currentMonth}`;
    const isSettled = (worker.settlements || []).includes(settlementKey);
    const settlementCardHTML = isSettled ? `
            <div class="card" style="background-color: rgba(34, 197, 94, 0.1); color: #15803d; flex-direction: row; align-items: center; justify-content: center; gap: 10px; margin: 20px 0; cursor: default; transform: none;">
                <i class="fas fa-check-circle"></i>
                <span style="font-weight: 700;">تمت تسوية هذا الشهر بنجاح</span>
            </div>
        ` : '';

    const calendarHTML = generateCalendar(currentMonth, currentYear, worker.attendance || []);
    const activityLogHTML = generateActivityLog(worker, null, currentYear, currentMonth, 'html', false); // Show all items, no actions

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('workers')" class="btn icon-btn" title="العودة للعمال"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">${worker.name}</h3>
        </div>

        <!-- Financial Summary -->
        <div class="grid-cards" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-top:0; margin-bottom: 20px;">
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;" title="مستحقات هذا الشهر فقط">
                <div style="font-size:13px; color:var(--muted);">إجمالي المستحقات</div>
                <div style="font-weight:800; font-size:18px; color:var(--primary);">${totalDue.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:13px; color:var(--muted);">اجمالي الخصومات</div>
                <div style="font-weight:800; font-size:18px; color:#f97316;">${totalPaid.toLocaleString()} د.ج</div>
            </div>
            <div class="card" style="cursor:default; transform:none; text-align:right; align-items:flex-start; padding:12px;">
                <div style="font-size:13px; color:var(--muted);">الرصيد المتبقي</div>
                <div style="font-weight:800; font-size:18px; color:${balance > 0 ? '#ef4444' : 'var(--primary)'};">${balance.toLocaleString()} د.ج</div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="card" style="cursor:default; transform:none; padding: 16px; margin-bottom: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; width:100%;">
                <button class="btn ghost" data-action="prev-month" data-id="${workerId}" data-month="${prevMonth.getMonth()}" data-year="${prevMonth.getFullYear()}">‹</button>
                <h4 style="margin:0; font-weight:700;">${new Intl.DateTimeFormat('ar-DZ', { month: 'long', year: 'numeric' }).format(new Date(currentYear, currentMonth))}</h4>
                <button class="btn ghost" data-action="next-month" data-id="${workerId}" data-month="${nextMonth.getMonth()}" data-year="${nextMonth.getFullYear()}">›</button>
            </div>
            <div class="calendar">
                ${['ح', 'ن', 'ث', 'ر', 'خ', 'ج', 'س'].map(d => `<div class="calendar-header">${d}</div>`).join('')}
                ${calendarHTML}
            </div>
        </div>

        <!-- Settlement Card -->
        ${settlementCardHTML}

        <h4 style="margin: 24px 0 12px; font-weight:700;">أنشطة الشهر</h4>
        <div id="shortActivityLog">
            ${activityLogHTML}
        </div>
  `;
  }

  function generateCalendar(month, year, attendance) {
    let calendarHTML = '';
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    // Add empty cells for days before the 1st of the month
    for (let i = 0; i < firstDay; i++) {
        calendarHTML += `<div class="calendar-day not-in-month"></div>`;
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const record = attendance.find(a => a.date === dateStr);
        const statusClass = record ? record.status : ''; // 'present' or 'absent'
        calendarHTML += `<div class="calendar-day ${statusClass}">${day}</div>`;
    }
    return calendarHTML;
  }

  function generateActivityLog(worker, limit = null, year = null, month = null, format = 'html', showActions = false) {
    let combined = [
        ...(worker.attendance || []).map(a => ({ ...a, type: 'attendance' })),
        ...(worker.payments || []).map(p => ({ ...p, type: p.type || 'payment' })), // Ensure backward compatibility
        ...(worker.bonuses || []).map(b => ({ ...b, type: 'bonus' }))
    ].sort((a, b) => new Date(b.date) - new Date(a.date));

    if (year !== null && month !== null) {
        combined = combined.filter(item => {
            const itemDate = new Date(item.date);
            return itemDate.getFullYear() === year && itemDate.getMonth() === month;
        });
    }

    const itemsToRender = limit ? combined.slice(0, limit) : combined;

    if (itemsToRender.length === 0) {
        return format === 'html' ? `<p style="text-align:center; color:var(--muted);">لا توجد أنشطة مسجلة.</p>` : 'لا توجد أنشطة مسجلة.';
    }

    return itemsToRender.map((item, index) => {
        const date = new Intl.DateTimeFormat('ar-DZ', { day: '2-digit', month: 'long', year: 'numeric' }).format(new Date(item.date));
        const deleteBtnHTML = showActions ? `<button class="delete-activity" data-worker-id="${worker.id}" data-activity-id="${item.id}" data-type="attendance" title="حذف">&times;</button>` : '';
        if (item.type === 'attendance') {
            const isPresent = item.status === 'present';
            return `
            <div class="activity-log-item">
                <div style="display:flex; align-items:center;">
                    <div class="icon" style="color: ${isPresent ? '#16a34a' : '#ef4444'}; background: ${isPresent ? 'rgba(34,197,94,.1)' : 'rgba(239,68,68,.1)'};">
                        <i class="fas ${isPresent ? 'fa-check' : 'fa-times'}"></i>
                    </div>
                    <div>
                        <div style="font-weight:500;">${isPresent ? `يوم عمل - ${(item.dailyRate || 0).toLocaleString()} د.ج` : 'غياب'}</div>
                        <div style="font-size:13px; color:var(--muted);">${date}</div>
                    </div>
                </div>
                ${deleteBtnHTML}
            </div>`
        } else { // Payment or Deduction
            const isDeduction = item.type === 'deduction';
            const title = `خصم / مصاريف: ${item.amount.toLocaleString()} د.ج`;
            const iconClass = isDeduction ? 'fa-hand-holding-usd' : 'fa-money-bill-wave';
            const iconColor = isDeduction ? '#8b5cf6' : '#f97316';
            const iconBg = isDeduction ? 'rgba(139,92,246,.1)' : 'rgba(249,115,22,.1)';

            const bonusDeleteBtnHTML = showActions ? `<button class="delete-activity" data-worker-id="${worker.id}" data-activity-id="${item.id}" data-type="bonus" title="حذف">&times;</button>` : '';
            if (item.type === 'bonus') {
                return `
                <div class="activity-log-item">
                    <div style="display:flex; align-items:center;">
                        <div class="icon" style="color: #3b82f6; background: rgba(59,130,246,.1);"><i class="fas fa-star"></i></div>
                        <div>
                            <div style="font-weight:500;">مكافأة: ${item.amount.toLocaleString()} د.ج</div>
                            <div style="font-size:13px; color:var(--muted);">${date}</div>
                            ${item.note ? `<div class="note"><i class="fas fa-quote-right" style="margin-left: 4px; opacity: 0.7;"></i> ${item.note}</div>` : ''}
                        </div>
                    </div>
                    ${bonusDeleteBtnHTML}
                </div>`;
            }

            const paymentDeleteBtnHTML = showActions ? `<button class="delete-activity" data-worker-id="${worker.id}" data-activity-id="${item.id}" data-type="${item.type}" title="حذف">&times;</button>` : '';
            return `
            <div class="activity-log-item">
                <div style="display:flex; align-items:center;">
                    <div class="icon" style="color: ${iconColor}; background: ${iconBg};"><i class="fas ${iconClass}"></i></div>
                    <div>
                        <div style="font-weight:500;">${title}</div>
                        <div style="font-size:13px; color:var(--muted);">${date}</div>
                        ${item.note ? `<div class="note"><i class="fas fa-quote-right" style="margin-left: 4px; opacity: 0.7;"></i> ${item.note}</div>` : ''}
                    </div>
                </div>
                ${paymentDeleteBtnHTML}
            </div>`;
        }
    }).join('');
  }

  function calculateWorkerFinancials(worker, year = null, month = null) {
    const filterByMonth = (item) => {
        // If year or month is null, we want the total, so we include all items.
        if (year === null || month === null) return true; 
        const itemDate = new Date(item.date);
        return itemDate.getFullYear() === year && itemDate.getMonth() === month;
    };

    const relevantAttendance = (worker.attendance || []).filter(filterByMonth);
    const relevantBonuses = (worker.bonuses || []).filter(filterByMonth);
    const relevantPayments = (worker.payments || []).filter(filterByMonth);

    const presentDays = relevantAttendance.filter(a => a.status === 'present').length;
    const absentDays = relevantAttendance.filter(a => a.status === 'absent').length;
    
    const earningsFromWork = relevantAttendance.filter(a => a.status === 'present').reduce((sum, day) => sum + (day.dailyRate || 0), 0);
    const totalBonuses = relevantBonuses.reduce((sum, b) => sum + b.amount, 0);
    const totalDue = earningsFromWork + totalBonuses;
    const totalPaid = relevantPayments.reduce((sum, p) => sum + p.amount, 0);

    return { totalDue, totalPaid, presentDays, absentDays };
  }

  function getSettingsView() {
    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">الإعدادات</h3>
        </div>
        <div id="navigateToThemes" class="card" style="align-items:flex-start; text-align:right; flex-direction: row; justify-content: space-between; margin-bottom: 12px;">
            <div style="display:flex; justify-content:space-between; align-items:center; width: 100%;">
                <div style="display:flex; align-items:center; gap: 12px;">
                    <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#ec4899,#d946ef); font-size: 20px; margin-bottom: 0;"><i class="fas fa-palette"></i></div>
                    <div>
                        <div style="font-weight:700;">تخصيص الثيمات</div>
                        <div style="font-size:13px; color: var(--muted)">تغيير ألوان ومظهر التطبيق</div>
                    </div>
                </div>
                <i class="fas fa-chevron-left" style="color: var(--muted); align-self: center;"></i>
            </div>
        </div>

        <!-- *** إضافة: بطاقة مسح ذاكرة التخزين المؤقت *** -->
        <div id="navigateToClearCache" class="card" style="align-items:flex-start; text-align:right; flex-direction: row; justify-content: space-between; margin-top: 12px; border-top: 2px solid #f43f5e;">
            <div style="display:flex; align-items:center; gap: 12px;">
                <div class="icon" style="width:48px; height:48px; background: linear-gradient(135deg,#f43f5e,#be123c); font-size: 20px; margin-bottom: 0;"><i class="fas fa-broom"></i></div>
                <div>
                    <div style="font-weight:700; color: #f43f5e;">مسح ذاكرة التخزين المؤقت</div>
                    <div style="font-size:13px; color: var(--muted)">حل المشاكل وإعادة تحميل البيانات</div>
                </div>
            </div>
            <i class="fas fa-chevron-left" style="color: var(--muted); align-self: center;"></i>
        </div>
    `;
  }

  function getThemesView() {
    const currentThemeName = state.selected_theme || 'default-light';
    
    const createThemeCard = (themeKey) => {
        const theme = themes[themeKey];
        const isActive = themeKey === currentThemeName;
        return `
            <div class="card theme-card" data-theme="${themeKey}" style="padding: 12px; border-color: ${isActive ? 'var(--primary)' : 'transparent'};">
                <div style="display: flex; gap: 8px; width: 100%; height: 60px; margin-bottom: 12px;">
                    <div style="flex: 1; background-color: ${theme.colors['--bg']}; border-radius: 6px;"></div>
                    <div style="flex: 2; background-color: ${theme.colors['--card']}; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <div style="width: 20px; height: 20px; border-radius: 50%; background-color: ${theme.colors['--primary']};"></div>
                        <div style="width: 20px; height: 20px; border-radius: 50%; background-color: ${theme.colors['--accent']};"></div>
                    </div>
                </div>
                <div style="font-weight: 700; font-size: 14px;">${theme.name}</div>
                ${isActive ? `<div style="position: absolute; top: 8px; left: 8px; color: var(--primary); font-size: 18px;"><i class="fas fa-check-circle"></i></div>` : ''}
            </div>
        `;
    };

    const lightThemesHTML = Object.keys(themes).filter(key => themes[key].type === 'light').map(createThemeCard).join('');
    const darkThemesHTML = Object.keys(themes).filter(key => themes[key].type === 'dark').map(createThemeCard).join('');

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('settings')" class="btn icon-btn" title="العودة للإعدادات"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">تخصيص الثيمات</h3>
        </div>

        <h4 style="margin: 24px 0 12px; font-weight:700;">الثيمات الفاتحة</h4>
        <div class="grid-cards" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); margin-top: 0;">
            ${lightThemesHTML}
        </div>

        <h4 style="margin: 24px 0 12px; font-weight:700;">الثيمات الداكنة</h4>
        <div class="grid-cards" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); margin-top: 0;">
            ${darkThemesHTML}
        </div>
    `;
  }

  // *** إضافة: دالة لإنشاء واجهة مسح الكاش ***
  function getClearCacheView() {
    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('settings')" class="btn icon-btn" title="العودة للإعدادات"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; color: #f43f5e; text-align: right; flex-grow: 1;">مسح ذاكرة التخزين المؤقت</h3>
        </div>

        <div class="card" style="cursor:default; transform:none; padding: 20px; align-items: center; text-align: center; border-color: #f43f5e;">
            <div style="font-size: 48px; color: #f43f5e; margin-bottom: 16px;"><i class="fas fa-exclamation-triangle"></i></div>
            <h4 style="margin: 0 0 8px; font-size: 18px;">إجراء مهم</h4>
            <p style="color: var(--muted); line-height: 1.7; max-width: 400px; margin-bottom: 24px;">
                <strong>نصيحة:</strong> استخدم هذه الميزة إذا واجهت مشاكل في عرض البيانات أو سلوكاً غير متوقع في التطبيق.
                سيؤدي مسح الكاش إلى حذف البيانات المؤقتة وإجبار التطبيق على إعادة تحميل أحدث المعلومات من السحابة عند التحديث.
                <strong>لن يتم حذف بياناتك الأساسية.</strong>
            </p>
            <button id="clearCacheBtn" class="btn" style="background-color: #f43f5e; padding: 10px 24px; font-size: 16px; gap: 8px;">
                <i class="fas fa-broom" style="margin-left: 8px;"></i> نعم، أفهم وأريد مسح الكاش
            </button>
        </div>
    `;
  }

  // *** إضافة: دالة لتنفيذ مسح الكاش ***
  function handleClearCache() {
      openConfirmModal('هل أنت متأكد من رغبتك في مسح ذاكرة التخزين المؤقت؟', () => {
          closeConfirmModal();
          showToast('جاري مسح الكاش...');
          // حذف البيانات المؤقتة من localStorage
          const user = auth.currentUser;
          if (user) localStorage.removeItem(`lastSeenUpdate_${user.uid}`);
          localStorage.removeItem('lastSeenMessageTimestamp');
          // لا نحذف deviceId لأنه يجب أن يكون دائماً
          
          setTimeout(() => { location.reload(); }, 1500);
      });
  }

  // *** إضافة: واجهة مبدئية لسجل المشتريات للعامل ***
  function getPurchasesView() { 
        const activeTab = state.currentView.params.tab || 'pending';
        // Defensive: de-duplicate and sort purchases safely when createdAt might be
        // a Firestore Timestamp, a JS Date, or a number.
        function normalizeTimestamp(ts) {
            if (!ts) return 0;
            if (typeof ts.toDate === 'function') return ts.toDate().getTime();
            if (ts instanceof Date) return ts.getTime();
            if (typeof ts === 'number') return ts;
            if (ts && typeof ts.seconds === 'number') return ts.seconds * 1000;
            const parsed = Date.parse(ts);
            return isNaN(parsed) ? 0 : parsed;
        }

        function dedupePurchases(arr) {
            const map = new Map();
            for (const p of arr) {
                const key = p && (p.firestoreId || p.id || `${p.description}-${p.amount}-${p.date}`);
                if (!map.has(key)) map.set(key, p);
            }
            return Array.from(map.values());
        }

        const allPurchases = dedupePurchases(Array.isArray(state.purchases) ? state.purchases.slice() : []).sort((a, b) => normalizeTimestamp(b.createdAt) - normalizeTimestamp(a.createdAt));

        const filteredPurchases = allPurchases.filter(p => p.status === activeTab);

        const statusStyles = {
            pending: { text: 'قيد المراجعة', color: '#f59e0b', icon: 'fa-hourglass-half' },
            approved: { text: 'تمت الموافقة', color: '#10b981', icon: 'fa-check-circle' },
            rejected: { text: 'مرفوض', color: '#ef4444', icon: 'fa-times-circle' }
        };

        const purchasesListHTML = filteredPurchases.length > 0 ? filteredPurchases.map(purchase => {
            return `
            <div class="activity-log-item" data-action="view-purchase-details" data-firestore-id="${purchase.firestoreId || purchase.id || ''}" style="cursor: pointer;">
                <div style="display:flex; align-items:center; gap: 12px;" >
                    <div class="icon" style="background: var(--bg); color: var(--muted);"><i class="fas fa-receipt"></i></div>
                    <div>
                        <div style="font-weight: 700;">${purchase.description}</div>
                        <div style="font-size: 13px; color: var(--muted);">${new Date(purchase.date).toLocaleDateString('ar-DZ')}</div>
                    </div>
                </div>
                <div style="text-align: left; display:flex; align-items:center; justify-content:flex-end; gap:12px;">
                    <div style="font-weight: 700; font-size: 15px; color: #ef4444;">-${purchase.amount.toLocaleString()} د.ج</div>
                    <div class="status-badge" style="background-color: ${statusStyles[purchase.status]?.color || '#64748b'};">
                        ${statusStyles[purchase.status]?.text || 'غير معروف'}
                    </div>
                </div>
            </div>
        `}).join('') : `
            <p style="text-align:center; color:var(--muted); padding: 20px;">لا توجد سجلات في هذا القسم.</p>
        `;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">سجل المشتريات</h3>
            <button onclick="openPurchaseModal()" class="btn icon-btn" title="إضافة شراء جديد" ${!state.isSubscribed ? 'disabled' : ''}><i class="fas fa-plus"></i></button>
        </div>
        
        <!-- *** إضافة: تبويبات لتصفية الحالات *** -->
        <div class="tab-card-container">
            <div class="tab-card ${activeTab === 'pending' ? 'active' : ''}" onclick="renderView('purchases', {tab: 'pending'})" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                <i class="fas fa-hourglass-half"></i><span>قيد المراجعة</span>
            </div>
            <div class="tab-card ${activeTab === 'approved' ? 'active' : ''}" onclick="renderView('purchases', {tab: 'approved'})" style="background: linear-gradient(135deg, #10b981, #059669);">
                <i class="fas fa-check-circle"></i><span>المقبولة</span>
            </div>
            <div class="tab-card ${activeTab === 'rejected' ? 'active' : ''}" onclick="renderView('purchases', {tab: 'rejected'})" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <i class="fas fa-times-circle"></i><span>المرفوضة</span>
            </div>
        </div>

        <div id="purchasesTabContent" class="tab-content active">
        ${purchasesListHTML}
        </div>
    `;
  }

  // *** إضافة: دالة لإنشاء واجهة الملاحظات (منسوخة من تطبيق المدير مع تبسيط) ***
  function getNotesView() {
    // Sort notes by last updated time, descending
    const notesListHTML = state.notes && state.notes.length > 0
        ? state.notes.sort((a, b) => b.updatedAt - a.updatedAt).map(note => `
            <div class="note-card" data-id="${note.id}" style="border-top-color: ${note.color || 'var(--primary)'};">
                <div style="padding-bottom: 8px;">
                    <h4 class="note-title">${note.title || 'ملاحظة بدون عنوان'}</h4>
                    <p class="note-content">${note.content ? note.content.replace(/\n/g, '<br>') : 'لا يوجد محتوى'}</p>
                </div>
                <div class="note-footer">
                    <span>آخر تحديث: ${new Date(note.updatedAt).toLocaleDateString('ar-DZ')}</span>
                </div>
            </div>
        `).join('')
        : ``;

    const emptyStateHTML = !notesListHTML ? `<p style="text-align:center; color:var(--muted); padding: 20px;">لا توجد ملاحظات. أضف ملاحظتك الأولى!</p>` : '';

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">ملاحظات سريعة</h3>
        </div>
        
        <!-- Inline Note Form -->
        <div id="addNoteFormContainer" class="add-note-container">
            <input type="text" id="newNoteTitle" placeholder="عنوان..." style="display: none;">
            <textarea id="newNoteContent" placeholder="اكتب ملاحظة..." rows="1"></textarea>
            <div id="newNoteActions" class="new-note-actions" style="display: none;">
                <div class="color-swatches">
                    <div class="swatch selected" data-color="#3b82f6" style="background: #3b82f6;"></div>
                    <div class="swatch" data-color="#10b981" style="background: #10b981;"></div>
                    <div class="swatch" data-color="#f59e0b" style="background: #f59e0b;"></div>
                    <div class="swatch" data-color="#ef4444" style="background: #ef4444;"></div>
                    <div class="swatch" data-color="#64748b" style="background: #64748b;"></div>
                </div>
                <button id="saveNewNoteBtn" class="btn">حفظ</button>
            </div>
        </div>

        <div class="notes-grid">
            ${notesListHTML}
        </div>
        ${emptyStateHTML}
    `;
  }

  // *** إضافة: دالة لإدارة نموذج الإضافة المباشر للملاحظات ***
  function setupInlineNoteForm() {
      const container = document.getElementById('addNoteFormContainer');
      const titleInput = document.getElementById('newNoteTitle');
      const contentTextarea = document.getElementById('newNoteContent');
      const actionsDiv = document.getElementById('newNoteActions');
      const saveBtn = document.getElementById('saveNewNoteBtn');
      let selectedColor = '#3b82f6';

      const expandForm = () => { titleInput.style.display = 'block'; actionsDiv.style.display = 'flex'; contentTextarea.rows = 3; };
      const collapseForm = () => { titleInput.style.display = 'none'; actionsDiv.style.display = 'none'; contentTextarea.rows = 1; titleInput.value = ''; contentTextarea.value = ''; };

      contentTextarea.addEventListener('focus', expandForm);

      actionsDiv.querySelectorAll('.swatch').forEach(swatch => {
          swatch.addEventListener('click', () => {
              actionsDiv.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
              swatch.classList.add('selected');
              selectedColor = swatch.dataset.color;
          });
      });

      saveBtn.addEventListener('click', async () => { if (contentTextarea.value.trim() === '' && titleInput.value.trim() === '') { collapseForm(); return; } await db.notes.add({ title: titleInput.value, content: contentTextarea.value, color: selectedColor, updatedAt: Date.now() }); collapseForm(); renderView('notes'); });
  }

  /**
   * *** إضافة: دالة لفتح نافذة تفاصيل الشراء المنبثقة ***
   * تعرض جميع معلومات سجل الشراء بشكل احترافي.
   */
  async function openPurchaseDetailsModal(firestoreId) {
      const purchase = state.purchases.find(p => p.firestoreId === firestoreId);
      if (!purchase) {
          showCustomToast('لم يتم العثور على سجل الشراء.', 'error');
          return;
      }

      const statusStyles = {
          pending: { text: '⏳ قيد المراجعة', color: '#f59e0b' },
          approved: { text: '✅ مقبول', color: '#10b981' },
          rejected: { text: '❌ مرفوض', color: '#ef4444' }
      };

      const contentEl = document.getElementById('purchaseDetailsContent');
      const footerEl = document.getElementById('purchaseDetailsFooter');

      contentEl.innerHTML = `
          <div style="margin-bottom: 16px;">
              <div style="font-size:14px; color:var(--muted); display: flex; align-items: center; gap: 6px;"><i class="fas fa-info-circle"></i> الوصف</div>
              <div style="font-weight:700; font-size:18px; margin-top: 4px; padding-right: 20px;">${purchase.description}</div>
          </div>

          <div style="margin-bottom: 16px; padding-top: 12px; border-top: 1px solid var(--border-color);">
              <div style="font-size:14px; color:var(--muted); display: flex; align-items: center; gap: 6px;"><i class="fas fa-money-bill-wave"></i> المبلغ</div>
              <div style="font-weight:800; font-size:22px; color: #ef4444; padding-right: 20px;">${purchase.amount.toLocaleString()} د.ج</div>
          </div>

          <div style="margin-bottom: 16px; padding-top: 12px; border-top: 1px solid var(--border-color);">
              <div style="font-size:14px; color:var(--muted); display: flex; align-items: center; gap: 6px;"><i class="fas fa-calendar-alt"></i> التاريخ</div>
              <div style="font-weight:700; font-size:16px; padding-right: 20px;">${new Date(purchase.date).toLocaleDateString('ar-DZ', { dateStyle: 'long' })}</div>
          </div>

          ${purchase.notes ? `
          <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-color);">
              <div style="font-size:14px; color: var(--muted); display: flex; align-items: center; gap: 6px;"><i class="fas fa-sticky-note"></i> ملاحظات</div>
              <div style="font-weight:500; font-size:15px; margin-top: 4px; white-space: pre-wrap; padding-right: 20px;">${purchase.notes}</div>
          </div>` : ''} 

          <!-- *** تعديل: نقل قسم الحالة إلى الأسفل *** -->
          <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border-color);">
              <div style="font-size:14px; color:var(--muted); display: flex; align-items: center; gap: 6px;"><i class="fas fa-check-circle"></i> الحالة</div>
              <div class="status-badge" style="background-color: ${statusStyles[purchase.status]?.color || '#64748b'}; display: inline-block; margin-top: 4px; margin-right: 20px;">${statusStyles[purchase.status]?.text || 'غير معروف'}</div>
          </div>
      `;
       
      // بناء أزرار الـ footer
      // *** إصلاح: إظهار زر الحذف فقط إذا كان الطلب مقبولاً أو مرفوضاً ***
      const canDelete = purchase.status === 'approved' || purchase.status === 'rejected';
      let footerHTML = '';
      if (canDelete) {
          footerHTML += `<button class="btn ghost purchase-delete-btn" data-id="${purchase.firestoreId}" title="حذف السجل نهائياً" style="color: #ef4444; border-color: transparent; margin-left: auto;"><i class="fas fa-trash-alt"></i> حذف</button>`;
      }
      footerHTML += `<button data-action="close-modal" class="btn ghost">إغلاق</button>`;
      
      footerEl.innerHTML = footerHTML;
      footerEl.style.justifyContent = 'flex-end';

      // *** إضافة: تخزين ID السجل المعروض حالياً في النافذة ***
      // هذا يساعد في إغلاق النافذة الصحيحة عند الحذف
      const modal = document.getElementById('purchaseDetailsModal');
      if (modal) modal.dataset.displayingId = firestoreId;


      openModal('purchaseDetailsModal');
  }

  // ==================================================
  // ميزة الحذف بعد مراجعة المدير
  // - هنا يتم تنفيذ طلب الحذف إلى Firestore ثم حذف السجل محلياً من Dexie وإزالة العنصر من الواجهة DOM
  // - ربط الـ event listener لزر الحذف يتم في كتلة renderView بعد عرض view 'purchases'
  // - استدعاء Firebase deleteDoc يتم باستخدام firestore.collection('purchases').doc(id).delete()
  // ==================================================
  async function handlePurchaseDeleteClick(e) {
      // *** إصلاح: هذه الدالة الآن هي معالج الحدث الأصلي ***
      e.stopPropagation(); // منع فتح نافذة التفاصيل عند الضغط على زر الحذف
      const btn = e.currentTarget;
      openConfirmModal('هل أنت متأكد من حذف سجل الشراء هذا نهائياً؟', async () => {
          closeConfirmModal();
          await executePurchaseDelete(btn);
      });
  }

  // *** إصلاح: دالة جديدة لتنفيذ الحذف الفعلي بعد التأكيد ***
  async function executePurchaseDelete(btn) {
      const firestoreId = btn.dataset.id;
      const status = btn.dataset.status;
      const user = auth.currentUser;

      if (!user) {
          showCustomToast('يجب تسجيل الدخول لتنفيذ هذا الإجراء.', 'error');
          return;
      }
      if (!firestoreId || status === 'pending') { // تحقق إضافي
          showCustomToast('لا يمكن حذف سجل قيد المراجعة.', 'error');
          return;
      }

      btn.disabled = true;
      btn.style.opacity = '0.6';

      try {
          // *** إصلاح: إغلاق نافذة التفاصيل إذا كانت مفتوحة لهذا السجل ***
          closeModalIfOpen('purchaseDetailsModal', firestoreId);

          // *** تعديل: الحذف من مسار العامل الصحيح في Firestore ***
          await firestore.collection('users').doc(user.uid).collection('purchases').doc(firestoreId).delete();

          try {
              await db.purchases.delete(firestoreId);
          } catch (dexieErr) {
              console.warn('Failed to delete local purchase entry:', dexieErr);
          }

          state.purchases = (state.purchases || []).filter(p => (p.firestoreId || p.id) !== firestoreId);
          const itemEl = btn.closest('.activity-log-item');
          if (itemEl) {
              itemEl.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              itemEl.style.opacity = '0';
              itemEl.style.transform = 'translateX(-20px)';
              setTimeout(() => itemEl.remove(), 300);
          }

          showToast('تم حذف السجل بنجاح.');
      } catch (error) {
          console.error('Purchase delete failed:', error);
          // رسالة خطأ للمستخدم كما طُلب
          showCustomToast('⚠️ فشل الحذف من السيرفر', 'error');
          btn.disabled = false;
          btn.style.opacity = '';
      }
  }

  // Helper: delete purchase by Firestore id (centralized so modal and inline buttons reuse it)
  async function deletePurchaseById(firestoreId) {
      const user = auth.currentUser;
      if (!user) {
          showCustomToast('يجب تسجيل الدخول لتنفيذ هذا الإجراء.', 'error');
          throw new Error('User not authenticated');
      }
      if (!firestoreId) throw new Error('missing id');

      // Delete from Firestore
      // *** إصلاح: إغلاق نافذة التفاصيل قبل الحذف من الواجهة ***
      closeModalIfOpen('purchaseDetailsModal', firestoreId);

      // *** تعديل: الحذف من مسار العامل الصحيح في Firestore ***
      await firestore.collection('users').doc(user.uid).collection('purchases').doc(firestoreId).delete();

      // Delete from local Dexie (best-effort)
      try {
          await db.purchases.delete(firestoreId);
      } catch (err) {
          console.warn('Local delete failed for purchase', firestoreId, err);
      }
      // Update local state and UI
      state.purchases = (state.purchases || []).filter(p => (p.firestoreId || p.id) !== firestoreId);
      const domItem = document.querySelector(`.activity-log-item[data-firestore-id="${firestoreId}"]`);
      if (domItem) domItem.remove();
  }

 function openPurchaseModal() {
      // *** إضافة: التحقق من الاشتراك قبل فتح النافذة ***
      if (!state.isSubscribed) {
          showCustomToast('هذه الميزة تتطلب اشتراكاً فعالاً من المدير.', 'error');
          return;
      }
      const form = document.getElementById('purchaseForm');
      form.reset();
      document.getElementById('purchaseDate').valueAsDate = new Date();
      openModal('purchaseModal');
  }

  /**
   * *** تحسين: تطبيق نهج "Offline-first" ومعالجة الأخطاء ***
   * يتم الآن حفظ الشراء محليًا أولاً، ثم إرساله إلى Firestore.
   */
  async function handlePurchaseFormSubmit(e) { 
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      if (submitBtn.disabled) return; // Prevent double submission
      submitBtn.disabled = true;

      const user = auth.currentUser;
      if (!user) {
          showCustomToast('يجب تسجيل الدخول لإضافة مشتريات.', 'error');
          submitBtn.disabled = false;
          return;
      }
      
      const purchaseData = {
          // *** تعديل: جلب اسم العامل من الحقل الجديد ***
          workerName: document.getElementById('purchaseWorkerName').value,
          description: document.getElementById('purchaseDescription').value,
          amount: parseFloat(document.getElementById('purchaseAmount').value),
          date: document.getElementById('purchaseDate').value,
          notes: document.getElementById('purchaseNotes').value,
          workerId: user.uid,
          status: 'pending'
      };

      // *** إضافة: تحقق أخير من جانب الخادم (المنطق) قبل الإرسال ***
      if (!state.isSubscribed) {
          showCustomToast('لا يمكن إرسال الطلب. اشتراك المدير غير فعال.', 'error');
          submitBtn.disabled = false;
          return;
      }

      try {
          // *** إصلاح: الخطوة 1 - إضافة البيانات إلى Firestore أولاً للحصول على ID ***
          // *** تعديل: الكتابة مباشرة في مستند المستخدم الحالي ***
          const docRef = await firestore.collection('users').doc(user.uid).collection('purchases').add({
              ...purchaseData,
              // *** إضافة: تخزين createdAt كطابع زمني للسيرفر ***
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          const newPurchaseRecord = {
              ...purchaseData,
              firestoreId: docRef.id, // *** تعديل: التأكد من أن workerName من الحقل الجديد يتم حفظه محلياً أيضاً ***
              createdAt: new Date() // Use local date for immediate sorting
          };

          // *** إصلاح: الخطوة 2 - حفظ البيانات في Dexie باستخدام firestoreId كمفتاح أساسي ***
          await db.purchases.put(newPurchaseRecord);
          // *** تعديل: تحديث الحالة المحلية فوراً لعرض الطلب الجديد ***
          state.purchases.push(newPurchaseRecord);

          // Show success message and update UI
          showToast('تم إرسال طلب الشراء للمراجعة.');
          closeModal('purchaseModal');
          
          // Refresh the purchases view if we're on it
          if (state.currentView.name === 'purchases') await renderView('purchases');

      } catch (error) {
          console.error("Error adding purchase (offline or online):", error);
          showCustomToast('فشل إرسال الطلب. تحقق من اتصالك بالإنترنت.', 'error');
      }
      finally {
          submitBtn.disabled = false;
      }
  }

  /**
   * *** إضافة: دالة احترافية لتنسيق الوقت النسبي للرسائل ***
   * تعرض "منذ 5 دقائق" أو "أمس" بدلاً من التاريخ الكامل للرسائل الحديثة.
   */
  function formatRelativeTime(timestamp) {
      const now = new Date();
      const messageDate = new Date(timestamp);
      const diffInSeconds = Math.floor((now - messageDate) / 1000);
      const diffInDays = Math.floor(diffInSeconds / 86400);

      if (isNaN(diffInSeconds)) {
          return "وقت غير معروف";
      }

      if (diffInSeconds < 60) {
          return `الآن`;
      }

      const rtf = new Intl.RelativeTimeFormat('ar', { numeric: 'auto' });

      if (diffInDays < 7) {
          if (diffInDays > 0) return rtf.format(-diffInDays, 'day');
          const diffInHours = Math.floor(diffInSeconds / 3600);
          if (diffInHours > 0) return rtf.format(-diffInHours, 'hour');
          const diffInMinutes = Math.floor(diffInSeconds / 60);
          return rtf.format(-diffInMinutes, 'minute');
      }

      // للرسائل الأقدم من أسبوع، اعرض التاريخ العادي
      return messageDate.toLocaleString('ar-DZ', { dateStyle: 'medium', timeStyle: 'short' });
  }

  /**
   * *** إضافة: دالة لتنسيق الوقت المتبقي قبل الحذف ***
   */
  function formatRemainingTime(ms) {
      if (ms <= 0) {
          return 'سيتم الحذف قريباً';
      }

      const totalSeconds = Math.floor(ms / 1000);
      const totalMinutes = Math.floor(totalSeconds / 60);
      const totalHours = Math.floor(totalMinutes / 60);

      const hours = totalHours;
      const minutes = totalMinutes % 60;

      if (hours > 0) {
          return `يتبقى: ${hours} ساعة و ${minutes} دقيقة`;
      } else if (minutes > 0) {
          return `يتبقى: ${minutes} دقيقة`;
      } else {
          return 'يتبقى: أقل من دقيقة';
      }
  }


  // *** إضافة: دوال خاصة بنافذة الرسائل ***
  function openMessagesModal() {
      // *** إضافة: التحقق من وجود اشتراك فعال قبل عرض الرسائل ***
      const user = auth.currentUser;
      if (!user || !state.isSubscribed) {
          showCustomToast('هذه الميزة تتطلب اشتراكاً فعالاً من المدير.', 'error');
          return;
      }

      renderMessages();
      openModal('messagesModal');
      // إخفاء نقطة الإشعار عند فتح النافذة
      if (state.hasNewMessages) {
          state.hasNewMessages = false;
          localStorage.setItem('lastSeenMessageTimestamp', Date.now().toString());
          updateNotificationDots();
      }
  }

  /**
   * *** تعديل: دالة جديدة لرسم الرسائل مع منطق "عرض الكل" ***
   */
  function renderMessages() {
      const fortyEightHoursAgo = Date.now() - 48 * 60 * 60 * 1000;
      const container = document.getElementById('messagesListContainer');
      // *** إصلاح: تصفية الرسائل التي انتهت صلاحيتها قبل عرضها ***
      const validMessages = state.messages.filter(msg => {
          const timestampMs = typeof msg.timestamp === 'number' ? msg.timestamp : new Date(msg.timestamp).getTime();
          return timestampMs > fortyEightHoursAgo;
      });
  
      const sortedMessages = validMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  
      if (sortedMessages.length === 0) {
          container.innerHTML = `<p style="text-align:center; color:var(--muted);">لا توجد رسائل واردة.</p>`;
          return;
      }
  
      const messagesToDisplay = state.showAllMessages ? sortedMessages : sortedMessages.slice(0, 3);

      let messagesHTML = messagesToDisplay.map(msg => {
          const formattedDate = formatRelativeTime(msg.timestamp);
          // *** إصلاح: التأكد من أن msg.timestamp هو رقم قبل إجراء العمليات الحسابية ***
          const timestampMs = typeof msg.timestamp === 'number' ? msg.timestamp : new Date(msg.timestamp).getTime();
          const remainingMs = (timestampMs + 48 * 60 * 60 * 1000) - Date.now();
          const remainingTimeStr = formatRemainingTime(remainingMs);

          return `
              <div class="message-item">
                  <div class="message-header">
                      <i class="fas fa-user-tie" style="color: var(--primary);"></i>
                      <span>من: المدير</span>
                      <span style="margin-right: auto;">${formattedDate}</span>
                  </div>
                  <p class="message-text">${msg.text}</p>
                  <div class="message-footer">
                      <i class="fas fa-hourglass-half" style="margin-left: 4px;"></i>
                      <span>${remainingTimeStr}</span>
                  </div>
              </div>
          `;
      }).join('');

      if (!state.showAllMessages && sortedMessages.length > 3) {
          messagesHTML += `<button id="showAllMessagesBtn" class="btn" style="width: 100%; margin-top: 12px; background: var(--bg); color: var(--text-primary); border: 1px solid var(--border-color);">عرض الكل (${sortedMessages.length})</button>`;
      }

      container.innerHTML = messagesHTML;

      document.getElementById('showAllMessagesBtn')?.addEventListener('click', () => {
          state.showAllMessages = true;
          renderMessages();
      });
  }

  function updateNotificationDots() {
      // *** إصلاح: تحديث جميع نقاط الإشعارات في التطبيق بغض النظر عن الواجهة الحالية ***
      // تحديث إشعار الرسائل في الشريط العلوي
      const messagesDot = document.getElementById('messagesNotificationDot');
      if (messagesDot) {
          messagesDot.style.display = state.hasNewMessages ? 'block' : 'none';
      }
  
      // تحديث نقاط الإشعارات على بطاقات الوحدات
      appModules.forEach(module => {
          document.querySelectorAll(`.card[data-key="${module.key}"] .notification-dot`).forEach(dot => {
              const shouldShow = typeof module.hasNotification === 'function' && module.hasNotification();
              dot.style.display = shouldShow ? 'block' : 'none';
          });
      });
  }


  // *** إضافة: نافذة منبثقة لإدخال PIN العامل ***
  document.body.insertAdjacentHTML('beforeend', `
    <div id="workerPinModal" class="modal-container modal-hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-content" style="max-width: 360px;">
          <div class="modal-header">
              <h3>التحقق من الهوية</h3>
              <button class="close-btn" data-action="close-modal">&times;</button>
          </div>
          <div class="modal-body" style="text-align: center;">
              <p style="margin-top:0; margin-bottom: 20px;">الرجاء إدخال رمز PIN الخاص بالعامل <strong id="pinWorkerName"></strong> للمتابعة.</p>
              <form id="workerPinForm">
                  <input type="hidden" id="pinWorkerId">
                  <div class="form-group">
                      <input type="password" id="pinInput" required pattern="\\d{4}" maxlength="4" style="text-align: center; font-size: 24px; letter-spacing: 10px;">
                  </div>
                  <div class="form-actions" style="justify-content: center;">
                      <button type="submit" class="btn" style="flex: 1;">دخول</button>
                  </div>
              </form>
          </div>
      </div>
    </div>
  `);

  function openWorkerPinModal(workerId) {
    const worker = state.workers.find(w => w.id === workerId);
    if (!worker) return;

    document.getElementById('pinWorkerName').textContent = worker.name;
    document.getElementById('pinWorkerId').value = workerId;
    document.getElementById('workerPinForm').reset();
    openModal('workerPinModal');
  }

  function closeWorkerPinModal() {
    closeModal('workerPinModal');
  }

  async function handleWorkerPinSubmit(e) {
    e.preventDefault();
    const workerId = parseInt(document.getElementById('pinWorkerId').value);
    const enteredPin = document.getElementById('pinInput').value;

    const worker = state.workers.find(w => w.id === workerId);

    if (worker && worker.pin === enteredPin) {
        closeWorkerPinModal();
        renderView('worker-details', { id: workerId });
    } else {
        showCustomToast('رمز PIN غير صحيح!', 'error');
        const pinInput = document.getElementById('pinInput');
        pinInput.style.animation = 'shake 0.5s';
        setTimeout(() => { pinInput.style.animation = ''; }, 500);
        pinInput.value = '';
    }
  }

  document.getElementById('workerPinForm').addEventListener('submit', handleWorkerPinSubmit);
  document.getElementById('workerPinModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeWorkerPinModal();
      }
  });

  function getAboutView() {
    const appInfo = `
        <div class="card" style="cursor:default; transform:none; align-items:flex-start; text-align:right;">
            <h4 style="margin:0 0 12px; font-weight:800;">عن التطبيق</h4>
            <p style="margin:0; line-height:1.7;">
                <strong>My Decor Manager</strong> هو مساعدك الرقمي الشامل لإدارة أعمال الديكور والبناء. مصمم لتبسيط مهامك اليومية، من تتبع العمال والمشاريع إلى إدارة النفقات والموردين، كل ذلك في مكان واحد سهل الاستخدام.
            </p>
        </div>
    `;

    const devInfo = `
        <div class="card" style="cursor:default; transform:none; align-items:flex-start; text-align:right; margin-top: 20px;">
            <div style="display: flex; align-items: center; gap: 16px; width: 100%;">
                <img src="images/billel.png" alt="بلال بورابعة" style="width:80px; height:80px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid var(--border-color);">
                <div style="flex-grow: 1;">
                    <h4 style="margin: 0 0 4px; font-weight:800; font-size: 18px;">بلال بورابعة</h4>
                    <p style="margin: 0; color: var(--primary); font-size: 14px; font-weight: 700;">مطور برمجيات</p>
                </div>
            </div>
            <p style="margin:16px 0 0; line-height:1.7; border-top: 1px solid var(--border-color); padding-top: 16px; width: 100%;">👨‍💻 مطور برمجيات منذ 2014، شغوف بالذكاء الاصطناعي وهندسة البرمجيات. صاحب مدونة تقنية ومؤلف كتاب حول نظام أندرويد يصدر في 2025. معروف بلقب إمبراطور التقنية، بخبرة في تطوير التطبيقات عبر Android Studio وVisual Studio Code، مع مشاريع تعليمية وإبداعية لمشاركة المعرفة ودعم المطورين.</p>
            
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); width: 100%;">
                <h5 style="margin: 0 0 12px; font-size: 14px; color: var(--muted);">تواصل معي</h5>
                <div style="display: flex; gap: 20px; font-size: 24px;">
                    <a href="https://www.facebook.com/billel.bouraba" target="_blank" style="color: var(--muted); text-decoration: none;"><i class="fab fa-facebook"></i></a>
                    <a href="https://www.instagram.com/billel_bouraba/?hl=fr" target="_blank" style="color: var(--muted); text-decoration: none;"><i class="fab fa-instagram"></i></a>
                    <a href="mailto:billel.dadi123@gmail.com" style="color: var(--muted); text-decoration: none;"><i class="fas fa-envelope"></i></a>
                </div>
            </div>
        </div>
    `;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">حول التطبيق</h3>
        </div>
        ${appInfo}${devInfo}`;
  }

  function goBackToPreviousView() {
    if (state.previousView && state.previousView.name) {
        renderView(state.previousView.name, state.previousView.params);
    } else {
        renderView('home');
    }
  }

  const confirmModal = document.getElementById('confirmModal');
  const confirmModalMessage = document.getElementById('confirmModalMessage');
  const confirmModalConfirmBtn = document.getElementById('confirmModalConfirmBtn');
  const confirmModalCancelBtn = document.getElementById('confirmModalCancelBtn');
  let onConfirmCallback = null;

  function openConfirmModal(message, onConfirm) {
      onConfirmCallback = onConfirm;
      confirmModalMessage.innerHTML = message;
      openModal('confirmModal');
  }

  function closeConfirmModal() {
      closeModal('confirmModal');
      onConfirmCallback = null;
  }

  function openAttendanceConfirmModal(data) {
      state.tempAttendanceData = data;
      const date = new Intl.DateTimeFormat('ar-DZ', { day: '2-digit', month: 'long', year: 'numeric' }).format(new Date(data.date));
      document.getElementById('confirmDate').textContent = date;
      openModal('attendanceConfirmModal');
  }
  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('modal-hidden');
        document.body.style.overflow = 'hidden';
    }
  }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('modal-hidden');
        document.body.style.overflow = '';
    }
  }

  function compressImage(file, maxSize, quality, callback) {
      const reader = new FileReader();
      reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;

              if (width > height) {
                  if (width > maxSize) { height *= maxSize / width; width = maxSize; }
              } else {
                  if (height > maxSize) { width *= maxSize / height; height = maxSize; }
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              callback(canvas.toDataURL('image/jpeg', quality));
          };
          img.src = event.target.result;
      };
      reader.readAsDataURL(file);
  }

  // --- Worker Modal Functions ---
  const workerModal = document.getElementById('workerModal');
  const workerForm = document.getElementById('workerForm');
  const activityModal = document.getElementById('activityModal');
  const activityForm = document.getElementById('activityForm');

  window.addEventListener('load', () => {
    setTimeout(() => {
      splash.classList.add('hidden');
      const appElement = document.getElementById('app');
      appElement.setAttribute('aria-hidden', 'false');
      appElement.style.visibility = 'visible';
    }, 1500);
  });
  
  mainNav.addEventListener('click', (e) => {
    const navItem = e.target.closest('.nav-item[data-view]');
    if (navItem) {
        const currentActive = mainNav.querySelector('.nav-item.active');
        if (!currentActive || currentActive.dataset.view !== navItem.dataset.view) {
            renderView(navItem.dataset.view, {});
        }
    }
  });

  document.getElementById('logoutBtn')?.addEventListener('click', async () => {
      try {
          await auth.signOut();
          // *** إضافة: تنظيف مستمعي Firestore عند تسجيل الخروج ***
          cleanupFirestoreListeners();
          // *** إصلاح جذري: مسح قاعدة البيانات المحلية عند تسجيل الخروج ***
          // هذا يضمن عدم تداخل بيانات حساب مع حساب آخر عند تسجيل الدخول مرة أخرى.
          // تم نقله بعد تسجيل الخروج لضمان إيقاف كل العمليات أولاً.
          await db.delete();
          console.log("Local database cleared on logout.");
          showToast('تم تسجيل الخروج بنجاح.'); 
          window.location.reload(); // إعادة تحميل الصفحة لتنظيف الحالة بالكامل
      } catch (error) {
          console.error("Logout Error:", error);
          showCustomToast('حدث خطأ أثناء تسجيل الخروج.', 'error');
      }
  });

  confirmModalCancelBtn.addEventListener('click', closeConfirmModal);
  confirmModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeConfirmModal();
      }
  });
  confirmModalConfirmBtn.addEventListener('click', () => {
      if (typeof onConfirmCallback === 'function') {
          onConfirmCallback();
      }
  });

  // Worker Modal Listeners
  workerForm.addEventListener('submit', handleWorkerFormSubmit);
  workerModal.addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeWorkerModal();
      }
  });
  document.getElementById('deleteWorkerBtn').addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذا العامل؟<br>سيتم حذف جميع بياناته بشكل نهائي.', async () => {
          const id = parseInt(document.getElementById('workerId').value);
          await db.workers.delete(id);
          renderView('workers');
          closeWorkerModal();
          closeConfirmModal();
      });
  });

  function initializeEventListeners() {
    themeToggleHeader.addEventListener('click', toggleTheme);

    // *** إضافة: معالج القائمة المنسدلة للمستخدم ***
    const userProfileBtn = document.getElementById('userProfileBtn');
    const userProfileDropdown = document.getElementById('userProfileDropdown');
    userProfileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        userProfileDropdown.style.display = userProfileDropdown.style.display === 'none' ? 'block' : 'none';
    });
    // إغلاق القائمة عند الضغط في أي مكان آخر
    document.addEventListener('click', (e) => {
        if (!userProfileBtn.contains(e.target) && !userProfileDropdown.contains(e.target)) {
            userProfileDropdown.style.display = 'none';
        }
    });

    document.getElementById('messagesBtn')?.addEventListener('click', openMessagesModal);
    document.getElementById('messagesModal')?.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
            state.showAllMessages = false;
            closeModal('messagesModal');
        }
    });

    const submitReportBtn = document.getElementById('submitReportBtn');
    if (submitReportBtn && !submitReportBtn.hasAttribute('data-listener-attached')) {
        submitReportBtn.setAttribute('data-listener-attached', 'true');
        submitReportBtn.addEventListener('click', handleReportFormSubmit);
    }

    document.getElementById('reportModal')?.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
            closeModal('reportModal');
        }
    });

    document.getElementById('workerSelectionContainer')?.addEventListener('click', (e) => {
        const card = e.target.closest('.worker-selection-card');
        if (!card) return;
        const { workerId, workerName, hasPin } = card.dataset;
        document.getElementById('reportForWorkerId').value = workerId;
        document.getElementById('reportForWorkerName').value = workerName;
        if (hasPin === 'true') {
            document.getElementById('reportStep1').style.display = 'none';
            document.getElementById('reportStep2').style.display = 'block';
            document.getElementById('reportPinWorkerName').textContent = workerName;
            document.getElementById('reportModalTitle').textContent = `التحقق من هوية ${workerName}`;
        } else {
            document.getElementById('reportStep1').style.display = 'none';
            document.getElementById('reportStep3').style.display = 'block';
            document.getElementById('reportModalTitle').innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-file-alt" style="color: var(--muted);"></i>
                    <span>تفاصيل البلاغ عن ${workerName}</span>
                </div>`;
        }
    });

    document.getElementById('reportBackToStep1')?.addEventListener('click', () => {
        document.getElementById('reportStep2').style.display = 'none';
        document.getElementById('reportStep1').style.display = 'block';
        document.getElementById('reportModalTitle').textContent = 'إرسال بلاغ';
    });

    document.getElementById('reportVerifyPin')?.addEventListener('click', () => {
        const workerId = parseInt(document.getElementById('reportForWorkerId').value);
        const worker = state.workers.find(w => w.id === workerId);
        const enteredPin = document.getElementById('reportPinInput').value;

        if (worker && worker.pin === enteredPin) {
            document.getElementById('reportStep2').style.display = 'none';
            document.getElementById('reportStep3').style.display = 'block';
            document.getElementById('reportModalTitle').innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-file-alt" style="color: var(--muted);"></i>
                    <span>تفاصيل البلاغ عن ${worker.name}</span>
                </div>`;
        } else {
            showCustomToast('رمز PIN غير صحيح!', 'error');
        }
    });

    document.querySelector('.report-type-selector')?.addEventListener('click', (e) => {
        const card = e.target.closest('.report-type-card');
        if (!card) return;
        document.querySelectorAll('.report-type-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        document.getElementById('reportType').value = card.dataset.type;
        handleReportTypeChange();
    });

    const purchaseForm = document.getElementById('purchaseForm');
    if (purchaseForm) {
        purchaseForm.addEventListener('submit', handlePurchaseFormSubmit);
    }
    document.getElementById('purchaseModal')?.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) closeModal('purchaseModal');
    });
    document.getElementById('purchaseDetailsModal')?.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
            closeModal('purchaseDetailsModal');
        }
    });

    // *** إصلاح جذري: استخدام Event Delegation لجميع الأحداث داخل المحتوى الرئيسي ***
    // هذا يمنع تراكم المستمعين ويحل مشكلة إعادة التشغيل.
    mainContent.addEventListener('click', (e) => {
        const target = e.target;

        // 1. النقر على بطاقات الوحدات في الصفحة الرئيسية
        const moduleCard = target.closest('.card[data-key]');
        if (moduleCard) {
            if (auth.currentUser && !state.isSubscribed) {
                if (moduleCard.dataset.key === 'purchases') {
                    showCustomToast('هذه الميزة تتطلب اشتراكاً فعالاً من المدير.', 'error');
                    return;
                }
            }
            renderView(moduleCard.dataset.key, {});
            return;
        }

        // 2. النقر على البلاغات المحمية لفتح نافذة PIN
        const protectedReport = target.closest('.protected-report[data-requires-pin="true"]');
        if (protectedReport) {
            const workerId = parseInt(protectedReport.dataset.workerId);
            const reportId = protectedReport.dataset.reportId;
            const worker = state.workers.find(w => w.id === workerId);
            if (worker) {
                openReportPinVerifyModal(reportId, worker.id, worker.name);
            }
            return;
        }
        // Delegation: فتح تفاصيل السجل عند الضغط على عنصر السجل
        const purchaseItem = target.closest('[data-action="view-purchase-details"]');
        if (purchaseItem && !target.closest('.purchase-delete-btn')) {
            const id = purchaseItem.dataset.firestoreId;
            if (id) openPurchaseDetailsModal(id);
            return; // *** إضافة: إيقاف التنفيذ بعد معالجة الحدث ***
        }

        const deleteBtn = target.closest('.purchase-delete-btn');
        if (deleteBtn) {
            e.stopPropagation(); // منع فتح نافذة التفاصيل
            handlePurchaseDeleteClick({ currentTarget: deleteBtn }); // استدعاء دالة الحذف
        }
    });

    // *** إصلاح: إضافة معالج أحداث لإغلاق نافذة تفاصيل الشراء ***
    document.getElementById('purchaseDetailsModal')?.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
            closeModal('purchaseDetailsModal');
        }
        // *** إصلاح: ربط حدث الحذف لزر الحذف داخل النافذة المنبثقة ***
        const deleteBtn = e.target.closest('.purchase-delete-btn');
        if (deleteBtn) {
            const firestoreId = deleteBtn.dataset.id;
            openConfirmModal('هل أنت متأكد من حذف هذا السجل نهائياً؟', async () => {
                closeConfirmModal();
                await deletePurchaseById(firestoreId);
            });
        }
    });

  }

  // *** إضافة: دالة مساعدة لإغلاق النافذة المنبثقة إذا كانت تعرض السجل المحدد ***
  function closeModalIfOpen(modalId, firestoreId) {
      const modal = document.getElementById(modalId);
      if (modal && !modal.classList.contains('modal-hidden') && modal.dataset.displayingId === firestoreId) {
          closeModal(modalId);
      }
  }

  // *** إضافة: دالة مساعدة لإغلاق النافذة المنبثقة إذا كانت تعرض السجل المحدد ***
  function closeModalIfOpen(modalId, firestoreId) {
      const modal = document.getElementById(modalId);
      if (modal && !modal.classList.contains('modal-hidden') && modal.dataset.displayingId === firestoreId) {
          closeModal(modalId);
      }
  }

  function openWorkerModal(workerId = null) {
      workerForm.reset(); 
      resetImagePreview();
      if (workerId) {
          const worker = state.workers.find(w => w.id === workerId);
          if (worker) {
              document.getElementById('workerModalTitle').textContent = 'تعديل بيانات العامل';
              document.getElementById('workerId').value = worker.id; 
              document.getElementById('workerName').value = worker.name;
              document.getElementById('workerPhone').value = worker.phone;
              document.getElementById('workerDailyRate').value = worker.dailyRate;
              if (worker.imageUrl) {
                  document.getElementById('workerImageDataBase64').value = worker.imageUrl;
                  document.getElementById('workerImagePreview').src = worker.imageUrl;
                  showImagePreview(true);
              }
              document.getElementById('deleteWorkerBtn').style.display = 'inline-block';
          }
      } else {
          document.getElementById('workerModalTitle').textContent = 'إضافة عامل جديد';
          document.getElementById('workerId').value = '';
          document.getElementById('deleteWorkerBtn').style.display = 'none';
      }
      openModal('workerModal');
  }

  function closeWorkerModal() {
      closeModal('workerModal');
  }

  function resetImagePreview() {
      document.getElementById('workerImageDataBase64').value = '';
      document.getElementById('workerImageInput').value = ''; // Reset file input
      document.getElementById('workerImagePreview').src = '';
      document.getElementById('workerImagePreview').style.display = 'none';
      document.getElementById('workerImagePlaceholder').style.display = 'flex';
      document.getElementById('workerImageRemoveBtn').style.display = 'none';
  }

  function showImagePreview(show) {
      document.getElementById('workerImagePreview').style.display = show ? 'block' : 'none';
      document.getElementById('workerImagePlaceholder').style.display = show ? 'none' : 'flex';
      document.getElementById('workerImageRemoveBtn').style.display = show ? 'inline-block' : 'none';
  }

  async function handleWorkerFormSubmit(e) {
      e.preventDefault();
      const id = document.getElementById('workerId').value ? parseInt(document.getElementById('workerId').value) : null;
      const workerData = {
          name: document.getElementById('workerName').value,
          phone: document.getElementById('workerPhone').value,
          imageUrl: document.getElementById('workerImageDataBase64').value,
          dailyRate: parseFloat(document.getElementById('workerDailyRate').value) || 0,
      };

      if (id) { // Update existing worker
          await db.workers.update(id, workerData);
      } else { // Add new worker
          workerData.attendance = [];
          workerData.bonuses = [];
          workerData.payments = [];
          workerData.settlements = [];
          await db.workers.add(workerData);
      }
      renderView(id ? state.currentView.name : 'workers', id ? { id: id } : {});
      closeWorkerModal();
  }

  function openActivityModal(type) {
      const workerId = state.currentView.params.id;
      if (!workerId) return;

      activityForm.reset();
      document.getElementById('activityWorkerId').value = workerId;
      document.getElementById('activityType').value = type;
      document.getElementById('activityDate').valueAsDate = new Date();
      
      const worker = state.workers.find(w => w.id == workerId);

      const isFinancial = type === 'deduction' || type === 'bonus';
      const paymentGroup = document.getElementById('paymentAmountGroup');
      const noteGroup = document.getElementById('activityNoteGroup');
      const attendanceRateGroup = document.getElementById('attendanceRateGroup');

      paymentGroup.style.display = isFinancial ? 'block' : 'none';
      noteGroup.style.display = isFinancial ? 'block' : 'none';
      document.getElementById('paymentAmount').required = isFinancial;
      
      attendanceRateGroup.style.display = type === 'attendance' ? 'block' : 'none';
      if (type === 'attendance' && worker) {
          document.getElementById('attendanceDailyRate').value = worker.dailyRate || '';
      }

      let title = 'تسجيل يوم عمل';
      if (type === 'deduction') title = 'تسجيل خصم / مصاريف';
      if (type === 'bonus') title = 'تسجيل مكافأة (منحة)';
      document.getElementById('activityModalTitle').textContent = title;
      
      openModal('activityModal');
  }

  function closeActivityModal() {
      closeModal('activityModal');
  }

  async function handleActivityFormSubmit(e) {
      e.preventDefault();
      const workerId = parseInt(document.getElementById('activityWorkerId').value);
      const type = document.getElementById('activityType').value;
      const date = document.getElementById('activityDate').value;

      const worker = state.workers.find(w => w.id == workerId);
      if (!worker) return;

      if (type === 'attendance' && worker.attendance) { 
          worker.attendance = worker.attendance.filter(a => a.date !== date);
      }

      if (type === 'deduction' || type === 'bonus') {
          const amount = parseFloat(document.getElementById('paymentAmount').value);
          const note = document.getElementById('activityNote').value;
          if (!amount || amount <= 0) return;
          const collection = type === 'bonus' ? 'bonuses' : 'payments';
          if (!worker[collection]) worker[collection] = [];
          worker[collection].push({ id: Date.now(), date, amount, note, type });
          await db.workers.update(workerId, { [collection]: worker[collection] });
      } else { // attendance
          if (!worker.attendance) worker.attendance = [];
          const dailyRate = parseFloat(document.getElementById('attendanceDailyRate').value) || worker.dailyRate || 0;
          openAttendanceConfirmModal({ worker, date, dailyRate });
          return;
      }
      
      renderView('worker-details', { id: workerId, month: new Date(date).getMonth(), year: new Date(date).getFullYear() });
      closeActivityModal();
  }

  // *** إضافة: دالة جلب أحدث بيانات العمال من Firestore ***
  async function fetchLatestWorkLogs() {
      const user = auth.currentUser;
      if (!user) {
          showCustomToast('يجب تسجيل الدخول لتحديث البيانات.', 'error');
          return;
      }

      const refreshBtn = document.getElementById('refreshWorkersBtn');
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';

      try {
          // *** تعديل: العامل يقرأ مباشرة من مستند المستخدم الحالي ***
          const doc = await firestore.collection('users').doc(user.uid).collection('workLogs').doc('latest').get();

          if (!doc.exists) {
              showCustomToast('لا توجد بيانات مزامنة من المدير بعد.', 'error');
              return;
          }
          const latestLog = doc.data();
          let workersData = latestLog.workers;

          // *** إصلاح: التحقق من أن البيانات المستلمة هي مصفوفة صالحة قبل المتابعة ***
          if (!Array.isArray(workersData)) {
              showCustomToast('تم استلام بيانات غير صالحة من المدير.', 'error');
              return;
          }

          // *** إصلاح: التأكد من أن كل عامل لديه حقل `uid` ***
          // بيانات المدير لا تحتوي على `uid`، لذلك نضيفه هنا.
          workersData = workersData.map(worker => {
              // إذا كان العامل لديه `id` ولكن ليس لديه `uid`، نعتبر أن `uid` هو نفسه `id`
              if (worker.id && !worker.uid) worker.uid = worker.id;
              return worker;
          });
          // *** تعديل: إخفاء نقطة الإشعار وحفظ وقت آخر تحديث ناجح ***
          state.hasNewSync = false;
          const lastUpdateTime = latestLog.timestamp?.toDate().getTime();
          if (lastUpdateTime && user) {
              // *** إصلاح: حفظ وقت التحديث لكل مستخدم على حدة ***
              localStorage.setItem(`lastSeenUpdate_${user.uid}`, lastUpdateTime.toString());
          }

          // تحديث قاعدة البيانات المحلية (Dexie) بالبيانات الجديدة
          await db.transaction('rw', db.workers, async () => {
              await db.workers.clear(); // مسح البيانات القديمة
              await db.workers.bulkPut(workersData); // إضافة البيانات الجديدة
          });

          showToast('📥 تم جلب أحدث التحديثات');
          await renderView('workers'); // إعادة عرض الواجهة بالبيانات المحدثة
      } catch (error) {
          console.error("Failed to fetch work logs:", error);
          showCustomToast('فشل تحديث البيانات. تحقق من اتصالك بالإنترنت.', 'error');
      } finally {
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
      }
  }

  function closeAttendanceConfirmModal() { 
      closeModal('attendanceConfirmModal');
  }

  async function saveAttendance(status) {
      const { worker, date, dailyRate } = state.tempAttendanceData;
      worker.attendance.push({ id: Date.now(), date, status, dailyRate });
      await db.workers.update(worker.id, { attendance: worker.attendance });
      renderView('worker-details', { id: worker.id, month: new Date(date).getMonth(), year: new Date(date).getFullYear() });
      closeAttendanceConfirmModal();
      closeActivityModal();
  }

  async function handleDeleteActivity(e) {
      const btn = e.currentTarget;
      const workerId = parseInt(btn.dataset.workerId);
      openConfirmModal('هل أنت متأكد من حذف هذا النشاط؟', async () => {
          const { activityId, type } = btn.dataset;
          const worker = state.workers.find(w => w.id == workerId);
          if (!worker) return;
  
          if (type === 'attendance' && worker.attendance) {
              worker.attendance = worker.attendance.filter(a => a.id != activityId);
              await db.workers.update(workerId, { attendance: worker.attendance });
          } else if (type === 'deduction' && worker.payments) {
              worker.payments = worker.payments.filter(p => p.id != activityId);
              await db.workers.update(workerId, { payments: worker.payments });
          } else if (type === 'bonus' && worker.bonuses) {
              worker.bonuses = worker.bonuses.filter(b => b.id != activityId);
              await db.workers.update(workerId, { bonuses: worker.bonuses });
          }
          
          closeConfirmModal();
          await renderView('worker-details', { id: workerId });
      });
  }

  async function handleSettleMonth(workerId, year, month) {
      const worker = state.workers.find(w => w.id === workerId);
      if (!worker) return;

      const { totalDue, totalPaid } = calculateWorkerFinancials(worker, year, month);
      const balance = totalDue - totalPaid;

      if (balance > 0) {
          const settlementKey = `${year}-${month}`;
          const monthName = new Intl.DateTimeFormat('ar-DZ', { month: 'long' }).format(new Date(year, month));

          if (!worker.payments) worker.payments = [];
          worker.payments.push({ id: Date.now(), date: new Date(year, month, new Date(year, month + 1, 0).getDate()).toISOString().split('T')[0], amount: balance, note: `تسوية راتب شهر ${monthName}`, type: 'deduction' });
          
          if (!worker.settlements) worker.settlements = [];
          worker.settlements.push(settlementKey);

          await db.workers.update(workerId, { payments: worker.payments, settlements: worker.settlements });
          renderView('worker-details', { id: workerId, month, year });
      }
  }

  // *** إضافة: دوال خاصة بنافذة البلاغات ***
  function openReportModal() {
      if (!auth.currentUser) {
          showCustomToast('يجب تسجيل الدخول لإرسال بلاغ.', 'error');
          return;
      }
      const form = document.getElementById('reportForm');
      form.reset();

      // إظهار الخطوة الأولى وإخفاء الباقي
      document.getElementById('reportStep1').style.display = 'block';
      document.getElementById('reportStep2').style.display = 'none';
      document.getElementById('reportStep3').style.display = 'none';
      document.getElementById('reportModalTitle').textContent = 'إرسال بلاغ';

      openModal('reportModal');
      // *** إضافة: تعيين تاريخ اليوم تلقائياً لحقل التاريخ ***
      document.getElementById('reportDate').valueAsDate = new Date();
      handleReportTypeChange(); // استدعاء الدالة مرة واحدة لضبط الحالة الأولية

      // *** تحسين: بناء بطاقات اختيار العمال ***
      const workerSelectionContainer = document.getElementById('workerSelectionContainer');
      workerSelectionContainer.innerHTML = state.workers.map(w => `
        <div class="worker-selection-card" data-worker-id="${w.id}" data-worker-name="${w.name}" data-has-pin="${w.pin ? 'true' : 'false'}">
            <div class="icon" style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg,#f97316,#f59e0b); font-size: 24px; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-user"></i>
            </div>
            <span style="font-weight: 700; font-size: 14px;">${w.name}</span>
        </div>
      `).join('');
  }

  // *** إضافة: دالة لإدارة حقول التاريخ بناءً على نوع البلاغ ***
  function handleReportTypeChange() {
      const type = document.getElementById('reportType').value; // القيمة تأتي من الحقل المخفي الآن
      const singleDateGroup = document.getElementById('reportSingleDateGroup');
      const dateRangeGroup = document.getElementById('reportDateRangeGroup');

      if (type === 'طلب إجازة') {
          singleDateGroup.style.display = 'none';
          dateRangeGroup.style.display = 'block';
      } else {
          singleDateGroup.style.display = 'block';
          dateRangeGroup.style.display = 'none';
          // For "complaint", change the placeholder text
          const noteTextarea = document.getElementById('reportNote');
          noteTextarea.placeholder = (type === 'شكوى') ? 'اكتب سبب الشكوى هنا...' : 'اشرح سبب البلاغ...';
      }
  }

  async function handleReportFormSubmit(e) {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
          showCustomToast('انتهت الجلسة، يرجى تسجيل الدخول مرة أخرى.', 'error');
          return;
      }

      // *** تعديل: جلب البيانات من الحقول المخفية التي تم تعيينها في الخطوات السابقة ***
      const reportForWorkerLocalId = document.getElementById('reportForWorkerId').value;
      const reportForWorkerName = document.getElementById('reportForWorkerName').value;

      // *** إصلاح: البحث عن العامل في الحالة للحصول على uid الخاص به ***
      const targetWorker = state.workers.find(w => w.id == reportForWorkerLocalId);

      if (!targetWorker || !targetWorker.uid) {
          showCustomToast('خطأ: لم يتم تحديد العامل. يرجى البدء من جديد.', 'error');
          return;
      }

      const reportForWorkerUid = targetWorker.uid;
      // *** تعديل: منطق ذكي لجلب هوية المدير ***
      // 1. جلب مستند المستخدم الحالي (الذي يرسل البلاغ)
      const userDoc = await firestore.collection('users').doc(user.uid).get();
      // 2. إذا كان للمستخدم حقل `managerUid` (أي أنه عامل)، استخدمه.
      //    إذا لم يكن لديه (أي أنه مدير)، استخدم `uid` الخاص به كمدير للبلاغ.
      const managerUid = userDoc.data()?.managerUid || user.uid;

      if (!managerUid) { // هذا التحقق سيفشل فقط في حالات نادرة جداً
          showCustomToast('لا يمكن إرسال البلاغ. لم يتم ربط حسابك (أنت) بمدير.', 'error');
          return;
      }

      const reportType = document.getElementById('reportType').value;
      const reportData = {
          workerId: reportForWorkerUid, // *** إصلاح: استخدام uid العامل المستهدف
          workerName: reportForWorkerName, // اسم العامل الذي يتم التبليغ عنه
          managerUid: managerUid,
          submittedBy: user.uid, // هوية من أرسل البلاغ
          submittedByName: document.getElementById('userDisplayName')?.textContent || user.email,
          type: reportType,
          note: document.getElementById('reportNote').value,
          status: 'pending',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      // *** إضافة: منطق حفظ التواريخ بناءً على نوع البلاغ ***
      if (reportType === 'طلب إجازة') {
          reportData.startDate = document.getElementById('reportStartDate').value;
          reportData.endDate = document.getElementById('reportEndDate').value;
          reportData.date = reportData.startDate; // استخدام تاريخ البدء كتاريخ أساسي
      } else {
          reportData.date = document.getElementById('reportDate').value;
      }

      try {
          // *** إصلاح: إرسال البلاغ إلى Firestore فقط. ***
          // سيقوم مستمع onSnapshot بمعالجة الإضافة إلى قاعدة البيانات المحلية والحالة تلقائياً.
          await firestore.collection('reports').add(reportData);

          showToast('تم إرسال البلاغ إلى المدير بنجاح ✅');
          closeModal('reportModal');
          // لا حاجة لإعادة رسم الواجهة يدوياً، المستمع سيقوم بذلك.
      } catch (error) {
          console.error("Error sending report:", error);
          showCustomToast('فشل إرسال البلاغ. تحقق من اتصالك بالإنترنت.', 'error');
      }
  }

  // *** إضافة: دالة لإنشاء واجهة البلاغات ***
  function getReportsView() {
    const reportsListHTML = state.reports && state.reports.length > 0
        // *** تعديل: فرز البلاغات حسب تاريخ الإنشاء (الأحدث أولاً) ***
        ? state.reports.sort((a, b) => {
            // استخدام normalizeTimestamp لضمان المقارنة الصحيحة
            const timeA = normalizeTimestamp(a.createdAt);
            const timeB = normalizeTimestamp(b.createdAt);
            return timeB - timeA;
        })
        .map(report => {
            const statusStyles = {
                pending: { text: 'قيد المراجعة', color: '#f59e0b' },
                approved: { text: 'تمت الموافقة', color: '#10b981' },
                rejected: { text: 'مرفوض', color: '#ef4444' }
            };
            const status = statusStyles[report.status] || { text: report.status, color: '#64748b' };
            
            // *** إضافة: التحقق مما إذا كان البلاغ يتطلب PIN ***
            const targetWorker = state.workers.find(w => w.uid == report.workerId);
            const requiresPin = targetWorker && targetWorker.pin;
            const isProtected = requiresPin && !report.unlocked; // Check if it's protected and not yet unlocked in this session

            const cardClasses = `card ${isProtected ? 'protected-report' : ''}`;
            const cardDataAttributes = isProtected ? `data-requires-pin="true" data-worker-id="${targetWorker.id}" data-report-id="${report.firestoreId}"` : '';
            // *** تحسين: إضافة أيقونات ونصوص مختلفة حسب نوع البلاغ ***
            const reportTypeDetails = {
                'غياب': { icon: 'fa-calendar-times', text: 'بلاغ غياب' },
                'طلب إجازة': { icon: 'fa-umbrella-beach', text: 'طلب إجازة' },
                'شكوى': { icon: 'fa-gavel', text: 'شكوى' }
            };
            const typeInfo = reportTypeDetails[report.type] || { icon: 'fa-flag', text: 'بلاغ' };

            // *** إضافة: إخفاء عنوان البلاغ إذا كان محمياً ***
            const reportTitle = isProtected
                ? `${typeInfo.text.split(' ')[0]} عن: *****`
                : `${typeInfo.text} عن: ${report.workerName}`;
            const adminNoteHTML = report.adminNote ? `
                <div style="background: var(--bg); padding: 10px; border-radius: 8px; margin-top: 12px; border-right: 3px solid var(--accent);">
                    <div style="font-size: 13px; color: var(--muted); font-weight: 700; margin-bottom: 4px;">ملاحظة المدير:</div>
                    <p style="margin: 0; font-size: 14px; line-height: 1.6;">${report.adminNote}</p>
                </div>
            ` : '';

            const deleteButtonHTML = (report.status === 'approved' || report.status === 'rejected') ? `
                <button class="btn icon-btn ghost report-delete-btn" data-id="${report.firestoreId}" title="حذف البلاغ من سجلي" style="width: 32px; height: 32px; font-size: 14px; color: #ef4444; border: none; background: transparent;">
                    <i class="fas fa-trash-alt"></i>
                </button>
            ` : '';

            // *** تحسين: عرض التاريخ بشكل أفضل ***
            const dateDisplay = report.type === 'طلب إجازة'
                ? `<div style="display: flex; align-items: center; gap: 10px; justify-content: flex-end;"><span style="font-weight: 700;">${new Date(report.startDate).toLocaleDateString('ar-DZ')}</span> <i class="fas fa-arrow-left" style="font-size: 10px;"></i> <span style="font-weight: 700;">${new Date(report.endDate).toLocaleDateString('ar-DZ')}</span></div>`
                : `<span style="font-weight: 700;">${new Date(report.date).toLocaleDateString('ar-DZ', {dateStyle: 'long'})}</span>`;

            return `
            <div class="${cardClasses}" ${cardDataAttributes} style="align-items: stretch; text-align: right; margin-bottom: 12px; padding: 16px; cursor: ${isProtected ? 'pointer' : 'default'}; transform: none; border-right: 4px solid ${status.color};">
                <div class="report-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 10px; flex-grow: 1;">
                        <i class="fas ${typeInfo.icon}" style="color: var(--muted); font-size: 18px;"></i>
                        <span style="font-weight: 700; font-size: 16px;">${reportTitle}</span>
                    </div>
                    <!-- *** إصلاح: وضع زر الحذف والشارة في حاوية واحدة لمنع التداخل *** -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        ${deleteButtonHTML}
                        <span class="status-badge" style="background-color: ${status.color};">${status.text}</span>
                    </div>
                </div>
                <div class="report-content">
                    <p style="margin: 0 0 12px; color: var(--muted); line-height: 1.6;">${report.note}</p>
                    ${adminNoteHTML}
                </div>
                <div class="report-footer" style="font-size: 13px; color: var(--muted); text-align: left; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color);">
                     ${dateDisplay}
                </div>
                ${isProtected ? `
                    <div class="protected-overlay">
                        <i class="fas fa-lock" style="font-size: 24px; margin-bottom: 8px;"></i>
                        <span>محتوى محمي</span>
                        <small>اضغط لإدخال PIN وعرض التفاصيل</small>
                    </div>
                ` : ''}
            </div>
        `}).join('')
        : `<p style="text-align:center; color:var(--muted); padding: 20px;">لم تقم بإرسال أي بلاغات بعد.</p>`;

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px; gap: 12px;">
            <button onclick="renderView('home')" class="btn icon-btn" title="العودة للرئيسية"><i class="fas fa-arrow-right"></i></button>
            <h3 style="margin:0; font-weight:800; text-align: right; flex-grow: 1;">سجل بلاغاتي</h3>
            <button id="openReportModalBtn" class="btn icon-btn" title="إرسال بلاغ جديد">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        ${reportsListHTML}
    `;
  }

  /**
   * *** إضافة: دالة لحذف الرسائل القديمة تلقائياً ***
   * تحذف الرسائل التي مر عليها أكثر من 48 ساعة من قاعدة البيانات المحلية.
   */
  async function cleanupOldMessages() {
      try {
        const fortyEightHoursAgo = Date.now() - 48 * 60 * 60 * 1000;
        const deletedCount = await db.messages.where('timestamp').below(fortyEightHoursAgo).delete();
        if (deletedCount > 0) {
            console.log(`[Cleanup] Deleted ${deletedCount} old messages.`);
            // *** إصلاح: تحديث الحالة المحلية بعد الحذف مباشرة ***
            state.messages = state.messages.filter(msg => {
                const timestampMs = typeof msg.timestamp === 'number' ? msg.timestamp : new Date(msg.timestamp).getTime();
                return timestampMs >= fortyEightHoursAgo;
            });
        }
      } catch (error) {
          console.error("Error cleaning up old messages:", error);
      }
  }


  // *** إضافة: دوال خاصة بنافذة الملاحظات ***
  function openNoteModal(noteId = null) {
      const form = document.getElementById('noteForm');
      form.reset();
      document.getElementById('noteId').value = '';
      document.getElementById('deleteNoteBtn').style.display = 'none';
      
      // Reset color swatches
      document.querySelectorAll('#noteModal .swatch').forEach(s => s.classList.remove('selected'));
      const defaultSwatch = document.querySelector('#noteModal .swatch[data-color="#3b82f6"]');
      if (defaultSwatch) defaultSwatch.classList.add('selected');

      if (noteId) {
          const note = state.notes.find(n => n.id === noteId);
          if (note) {
              document.getElementById('noteModalTitle').textContent = 'تعديل ملاحظة';
              document.getElementById('noteId').value = note.id;
              document.getElementById('noteTitle').value = note.title;
              document.getElementById('noteContent').value = note.content;
              document.getElementById('deleteNoteBtn').style.display = 'inline-block';
              
              const selectedSwatch = document.querySelector(`#noteModal .swatch[data-color="${note.color}"]`);
              if (selectedSwatch) selectedSwatch.classList.add('selected');
          }
      } else {
          document.getElementById('noteModalTitle').textContent = 'إضافة ملاحظة جديدة';
      }
      openModal('noteModal');
  }

  function closeNoteModal() {
      closeModal('noteModal');
  }

  async function handleNoteFormSubmit(e) {
      e.preventDefault();
      const id = document.getElementById('noteId').value ? parseInt(document.getElementById('noteId').value) : null;
      const title = document.getElementById('noteTitle').value;
      const content = document.getElementById('noteContent').value;
      const selectedColor = document.querySelector('#noteModal .swatch.selected').dataset.color;

      const noteData = {
          title: title,
          content: content,
          color: selectedColor,
          updatedAt: Date.now()
      };

      if (id) {
          await db.notes.update(id, noteData);
      } else {
          await db.notes.add(noteData);
      }
      
      await renderView('notes');
      closeNoteModal();
  }

  document.getElementById('noteModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeNoteModal();
      }
  });

  document.getElementById('noteForm').addEventListener('submit', handleNoteFormSubmit);

  document.getElementById('deleteNoteBtn').addEventListener('click', () => {
      openConfirmModal('هل أنت متأكد من حذف هذه الملاحظة؟', async () => {
          const id = parseInt(document.getElementById('noteId').value);
          await db.notes.delete(id);
          await renderView('notes');
          closeNoteModal();
          closeConfirmModal();
      });
  });

  document.querySelector('#noteModal .color-swatches').addEventListener('click', (e) => {
      if (e.target.classList.contains('swatch')) {
          document.querySelectorAll('#noteModal .swatch').forEach(s => s.classList.remove('selected'));
          e.target.classList.add('selected');
      }
  });

  async function initializeApp() {
    if (isDbOpen) return; // Prevent re-initialization
    // *** إصلاح: تنظيف أي مستمعين قدامى عند بدء تشغيل التطبيق لضمان بداية نظيفة ***
    if (auth.currentUser) {
        cleanupFirestoreListeners();
    }

    try { 
        await db.open();
        isDbOpen = true; 

        await loadState();
        
        // *** إضافة: تشغيل دالة تنظيف الرسائل عند بدء تشغيل التطبيق ***
        await cleanupOldMessages();
        
        const savedTheme = await db.app_settings.get('selected_theme');
        const themeToApply = savedTheme ? savedTheme.value : 'default-light';
        await applyThemeSet(themeToApply);
        state.selected_theme = themeToApply;
        
        await renderView(state.currentView.name || 'home', state.currentView.params || {});
        
        initializeEventListeners();

        // Listener setup is now handled by onAuthStateChanged

        // Worker Image Listeners
        document.getElementById('workerImageUploadBtn').addEventListener('click', () => document.getElementById('workerImageInput').click());
        document.getElementById('workerImagePlaceholder').addEventListener('click', () => document.getElementById('workerImageInput').click());
        document.getElementById('workerImagePreview').addEventListener('click', () => document.getElementById('workerImageInput').click());
        document.getElementById('workerImageInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                compressImage(file, 512, 0.75, (compressedDataUrl) => {
                    document.getElementById('workerImageDataBase64').value = compressedDataUrl;
                    document.getElementById('workerImagePreview').src = compressedDataUrl;
                    showImagePreview(true);
                });
            }
        });
        document.getElementById('workerImageRemoveBtn').addEventListener('click', () => resetImagePreview());

    } catch (error) {
        console.error("Dexie initialization failed:", error);
        mainContent.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <h3 style="color: #ef4444;">حدث خطأ فادح أثناء تهيئة قاعدة البيانات.</h3>
                <p style="color: var(--muted); line-height: 1.6;">قد يكون هذا بسبب تحديث للتطبيق. لحل المشكلة، يرجى محاولة مسح بيانات الموقع من إعدادات المتصفح ثم إعادة تحميل الصفحة.</p>
            </div>`;
    }

    // Activity Modal Listeners
    activityForm.addEventListener('submit', handleActivityFormSubmit);
    activityModal.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
            closeActivityModal();
        }
    });

    // Attendance Confirmation Modal Listeners
    document.getElementById('confirmPresentBtn').addEventListener('click', () => saveAttendance('present'));
    document.getElementById('confirmAbsentBtn').addEventListener('click', () => saveAttendance('absent'));
  }

  auth.onAuthStateChanged(async user => {
      // *** تعديل: تهيئة التطبيق دائماً، وتحديث الواجهة حسب حالة المستخدم ***
      initializeApp().then(async () => {
        const loggedInView = document.getElementById('loggedInView');
        const loggedOutView = document.getElementById('loggedOutView');
        const userProfileIcon = document.getElementById('userProfileIcon');

        if (user) {
            // User is signed in
            console.log("Worker is signed in:", user.email);
            loggedInView.style.display = 'block';
            loggedOutView.style.display = 'none';
            userProfileIcon.className = 'fas fa-user-circle';

            const userDisplayName = document.getElementById('userDisplayName');
            const userDisplayEmail = document.getElementById('userDisplayEmail');
            
            // *** إصلاح: جلب حالة الاشتراك فوراً عند تسجيل الدخول لضمان ظهور الأقفال ***
            const userDoc = await firestore.collection('users').doc(user.uid).get();
            const userData = userDoc.data();
            state.isSubscribed = userData?.subscription?.isActive === true;

            firestore.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    userDisplayName.textContent = `${userData.firstName} ${userData.lastName}`;
                    userDisplayEmail.textContent = user.email;
                } else {
                    userDisplayName.textContent = user.email;
                    userDisplayEmail.textContent = 'عامل';
                }
            }).catch(() => {
                userDisplayName.textContent = user.email;
            });

            // *** الخطوة 3: إنشاء المستمعين عند تسجيل الدخول ***
            setupFirestoreListeners(user.uid);

            // Also react to localStorage changes (same-machine syncs)
            window.addEventListener('storage', (e) => {
                if (!e.key) return;
                if (e.key === 'workLogsLastSync') {
                    // Another tab performed a sync; mark worker UI as having new sync
                    try {
                        const val = parseInt(e.newValue || '0');
                        const lastSeen = parseInt(localStorage.getItem('lastBackupSyncTime_worker') || '0');
                        if (val > lastSeen) {
                            state.hasNewSync = true;
                            if (state.currentView.name === 'home') renderView('home');
                        }
                    } catch(err) { /* ignore */ }
                }
            });


        } else {
            // User is signed out or not logged in yet
            console.log("Worker is not signed in. Running in offline mode.");
            loggedInView.style.display = 'none';
            loggedOutView.style.display = 'block';
            userProfileIcon.className = 'fas fa-sign-in-alt';
            
            // *** الخطوة 3: تنظيف المستمعين عند تسجيل الخروج ***
            cleanupFirestoreListeners();
        }
      });
  });

  function cleanupFirestoreListeners() {
    firestoreUnsubscribeFunctions.forEach(unsubscribe => unsubscribe());
    firestoreUnsubscribeFunctions = [];
  }

  // *** إصلاح: تعريف الدالة بشكل صحيح ووضع الكود بداخلها ***
  function setupFirestoreListeners(workerUid) {
        // *** إصلاح جوهري: تنظيف أي مستمعين سابقين قبل إنشاء مستمعين جدد ***
        // هذا يضمن عدم وجود مستمعين مكررين ويعالج حالات إعادة تسجيل الدخول.
        cleanupFirestoreListeners();

        // مستمع لحالة الاشتراك (يجب أن يكون منفصلاً لأنه يحدث الواجهة)
        const subUnsubscribe = firestore.collection('users').doc(workerUid).onSnapshot(doc => {
            const newSubStatus = doc.data()?.subscription?.isActive === true;
            if (state.isSubscribed !== newSubStatus) {
                state.isSubscribed = newSubStatus;
                renderView(state.currentView.name, state.currentView.params); // تحديث الواجهة لإظهار/إخفاء الأقفال
            }
        });
        firestoreUnsubscribeFunctions.push(subUnsubscribe);

        // مستمع لسجلات العمل (المزامنة)
        const workLogsUnsubscribe = firestore.collection('users').doc(workerUid).collection('workLogs').doc('latest').onSnapshot(doc => {
            if (doc.exists) {
                const logData = doc.data();
                const lastUpdateTime = logData.timestamp?.toDate().getTime();
                const lastSeenTime = parseInt(localStorage.getItem(`lastSeenUpdate_${workerUid}`) || '0');
                if (lastUpdateTime && lastUpdateTime > lastSeenTime) {
                    state.hasNewSync = true;
                    // *** إصلاح: استدعاء دالة تحديث الإشعارات لضمان ظهور النقطة ***
                    updateNotificationDots();
                    const refreshBtn = document.getElementById('refreshWorkersBtn');
                    if (refreshBtn) refreshBtn.classList.add('glow');
                }
            }
        });
        firestoreUnsubscribeFunctions.push(workLogsUnsubscribe);

        // مستمع للرسائل (لا يحدث الواجهة مباشرة لتجنب التكرار)
        const messagesUnsubscribe = firestore.collection('users').doc(workerUid).collection('messages').onSnapshot(async (querySnapshot) => {
            const lastSeen = parseInt(localStorage.getItem('lastSeenMessageTimestamp') || '0');
            let newMessagesFound = false;
            for (const change of querySnapshot.docChanges()) {
                if (change.type === 'added') {
                    const data = change.doc.data();
                    const messageId = change.doc.id; // الحصول على معرّف المستند
                    const msgTimestamp = data.timestamp?.toDate().getTime() || Date.now();
                    const newMessage = { ...data, id: messageId, timestamp: msgTimestamp };

                    // *** إصلاح: التحقق من عدم وجود الرسالة قبل إضافتها لتجنب التكرار ***
                    if (state.messages.some(m => m.id === messageId)) continue;

                    await db.messages.add(newMessage);
                    state.messages.push(newMessage);
                    if (msgTimestamp > lastSeen) newMessagesFound = true; // لا يزال هذا ضرورياً للإشعارات
                }
            }
            if (newMessagesFound) {
                state.hasNewMessages = true;
                updateNotificationDots();
            }
        });
        firestoreUnsubscribeFunctions.push(messagesUnsubscribe);

        // *** إضافة: مستمع جديد لتحديثات سجل المشتريات ***
        // *** تعديل: تحسين المستمع ليتعامل مع جميع أنواع التغييرات ***
        const purchasesUnsubscribe = firestore.collection('users').doc(workerUid).collection('purchases')
            .onSnapshot(async (querySnapshot) => {
                let needsRender = false;
                for (const change of querySnapshot.docChanges()) {
                    const data = change.doc.data();
                    const firestoreId = change.doc.id;
                    // *** إصلاح: التأكد من أن createdAt موجود قبل محاولة تحويله ***
                    const timestamp = data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate().getTime() : new Date(data.createdAt).getTime()) : Date.now();
                    const record = { ...data, firestoreId: firestoreId, timestamp: timestamp };

                    if (change.type === 'added') {
                        // سجل جديد أضيف (قد يكون من جهاز آخر لنفس العامل)
                        await db.purchases.put(record);
                        if (!state.purchases.some(p => p.firestoreId === firestoreId)) {
                            state.purchases.push(record);
                            needsRender = true;
                        }
                    } else if (change.type === 'modified') {
                        // تم تحديث سجل (الحالة تغيرت من "قيد المراجعة" إلى "مقبول/مرفوض")
                        await db.purchases.put(record);
                        const index = state.purchases.findIndex(p => p.firestoreId === firestoreId);
                        if (index > -1) state.purchases[index] = record;
                        needsRender = true;
                        showToast(`تم تحديث حالة طلب: ${record.description}`);
                    } else if (change.type === 'removed') {
                        // *** تحسين: إزالة العنصر من الواجهة بسلاسة بدلاً من إعادة الرسم الكامل ***
                        if (state.currentView.name === 'purchases') {
                            const itemEl = document.querySelector(`.activity-log-item[data-firestore-id="${firestoreId}"]`);
                            if (itemEl) {
                                itemEl.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                itemEl.style.opacity = '0';
                                itemEl.style.transform = 'translateX(-20px)';
                                setTimeout(() => itemEl.remove(), 300);
                            }
                        }
                        // حذف السجل من قاعدة البيانات المحلية والحالة
                        await db.purchases.delete(firestoreId).catch(err => console.warn("Failed to delete from local DB on remove event:", err));
                        state.purchases = state.purchases.filter(p => p.firestoreId !== firestoreId);
                        showToast('تم الحذف بنجاح'); // إظهار الرسالة بعد التحديث
                    }
                }
                // *** تحسين: إعادة الرسم فقط عند الإضافة أو التعديل، وليس عند الحذف ***
                if (needsRender && state.currentView.name === 'purchases' && querySnapshot.docChanges().some(c => c.type !== 'removed')) {
                    await renderView('purchases');
                }
            });
        firestoreUnsubscribeFunctions.push(purchasesUnsubscribe);

        // *** إضافة: مستمع جديد لتحديثات البلاغات الخاصة بالعامل الحالي ***
        const reportsUnsubscribe = firestore.collection('reports')
            .where('submittedBy', '==', workerUid) // جلب البلاغات التي أرسلها هذا العامل
            .onSnapshot(async (querySnapshot) => {
                // *** إصلاح جذري: توحيد منطق التحديث لضمان إعادة الرسم الفوري ***
                let needsRender = false; // متغير لتتبع ما إذا كانت الواجهة بحاجة للتحديث
                try {
                    for (const change of querySnapshot.docChanges()) {
                        const data = change.doc.data();
                        const report = { ...data, firestoreId: change.doc.id, createdAt: normalizeTimestamp(data.createdAt) };
                        
                        if (change.type === 'added') {
                            // *** إصلاح: التحقق من عدم وجود البلاغ قبل إضافته لمنع التكرار ***
                            const exists = state.reports.some(r => r.firestoreId === report.firestoreId);
                            if (!exists) {
                                await db.reports.put(report);
                                state.reports.unshift(report); // إضافة البلاغ الجديد إلى بداية المصفوفة
                                needsRender = true;
                            }
                        } else if (change.type === 'modified') {
                            await db.reports.put(report); // put يعمل كـ update إذا كان السجل موجوداً
                            const index = state.reports.findIndex(r => r.firestoreId === report.firestoreId);
                            if (index > -1) {
                                state.reports[index] = report; // تحديث البلاغ الموجود
                            } else {
                                // إذا لم يكن موجوداً لسبب ما، أضفه
                                state.reports.unshift(report);
                            }
                            needsRender = true;
                            // *** إضافة: تفعيل نقطة الإشعار عند تحديث بلاغ ***
                            state.hasNewReportUpdates = true;
                            updateNotificationDots(); // تحديث الواجهة لإظهار النقطة

                            showToast(`تم تحديث حالة بلاغك.`);
                        } else if (change.type === 'removed') {
                            await db.reports.delete(report.firestoreId);
                            state.reports = state.reports.filter(r => r.firestoreId !== report.firestoreId); // إزالة البلاغ
                            needsRender = true;
                        }
                    }
                    // إعادة فرز المصفوفة لضمان الترتيب الصحيح دائماً
                    state.reports.sort((a, b) => normalizeTimestamp(b.createdAt) - normalizeTimestamp(a.createdAt));
                } catch (error) {
                    console.error("Error processing reports snapshot for worker:", error);
                }
                // *** إصلاح: إذا كانت هناك تغييرات والواجهة الحالية هي سجل البلاغات، أعد رسمها ***
                if (needsRender && state.currentView.name === 'reports') {
                    await renderView('reports');
                }
            }, (error) => {
                console.error("Error in reports snapshot listener:", error);
            });
        firestoreUnsubscribeFunctions.push(reportsUnsubscribe);

        // *** إضافة: ربط حدث الحذف للبلاغات باستخدام Event Delegation ***
        mainContent.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.report-delete-btn');
            if (deleteBtn) {
                handleDeleteReport(deleteBtn.dataset.id);
            }
        });
  }

  // *** إضافة: دوال خاصة بالتحقق من PIN للبلاغات ***
  function openReportPinVerifyModal(reportId, workerId, workerName) {
      const form = document.getElementById('reportPinVerifyForm');
      form.reset();
      document.getElementById('verifyPinReportId').value = reportId;
      document.getElementById('verifyPinWorkerId').value = workerId;
      document.getElementById('verifyPinWorkerName').textContent = workerName;
      openModal('reportPinVerifyModal');
  }

  async function verifyReportPinAndUnlock(workerId, reportId, enteredPin) {
      const worker = state.workers.find(w => w.id === workerId);
      if (worker && worker.pin === enteredPin) {
          // PIN صحيح
          // 1. تحديث حالة البلاغ في الذاكرة (state) لفتحه
          const report = state.reports.find(r => r.firestoreId === reportId);
          if (report) {
              report.unlocked = true;
          }
          
          // 2. إغلاق نافذة PIN
          closeModal('reportPinVerifyModal');

          // 3. إعادة رسم الواجهة لإظهار البطاقة غير المضببة
          await renderView('reports');
          showToast('تم التحقق بنجاح.');

      } else {
          // PIN خاطئ
          showCustomToast('رمز PIN غير صحيح!', 'error');
          const pinInput = document.getElementById('verifyPinInput');
          pinInput.style.animation = 'shake 0.5s';
          setTimeout(() => { pinInput.style.animation = ''; }, 500);
          pinInput.value = '';
      }
  }

  // *** إصلاح: إضافة معالج حدث الإرسال لنافذة التحقق من PIN ***
  document.getElementById('reportPinVerifyForm').addEventListener('submit', async (e) => {
      e.preventDefault(); // منع إعادة تحميل الصفحة
      const reportId = document.getElementById('verifyPinReportId').value;
      const workerId = parseInt(document.getElementById('verifyPinWorkerId').value);
      const enteredPin = document.getElementById('verifyPinInput').value;
      await verifyReportPinAndUnlock(workerId, reportId, enteredPin);
  });

  document.getElementById('reportPinVerifyModal').addEventListener('click', (e) => {
      if (e.target.dataset.action === 'close-modal' || e.target.classList.contains('modal-backdrop')) {
          closeModal('reportPinVerifyModal');
      }
  });




  // *** إضافة: دالة لحذف البلاغ محلياً ***
  async function handleDeleteReport(firestoreId) {
      openConfirmModal('هل أنت متأكد من حذف هذا البلاغ من سجلك؟', async () => {
          closeConfirmModal(); // Close the confirmation modal immediately
          const user = auth.currentUser;
          if (!user) {
              showCustomToast('يجب تسجيل الدخول لتنفيذ هذا الإجراء.', 'error');
              return;
          }

          try {
              // *** FIX: Verify ownership before deleting ***
              // 1. Get the report document from Firestore first.
              const reportRef = firestore.collection('reports').doc(firestoreId);
              const reportDoc = await reportRef.get();

              if (!reportDoc.exists) {
                  throw new Error("لم يتم العثور على البلاغ.");
              }

              // 2. Check if the current user is the one who submitted it.
              if (reportDoc.data().submittedBy !== user.uid) {
                  throw new Error("ليس لديك صلاحية حذف هذا البلاغ.");
              }

              // 3. If the check passes, proceed with deletion.
              await firestore.collection('reports').doc(firestoreId).delete();

              // Delete from local Dexie database
              await db.reports.delete(firestoreId);
              // Update the state
              state.reports = state.reports.filter(r => r.firestoreId !== firestoreId);
              // Re-render the view
              await renderView('reports');
              showToast('تم حذف البلاغ بنجاح.');
          } catch (error) {
              console.error("Error deleting report:", error);
              showCustomToast(`فشل حذف البلاغ: ${error.message}`, 'error');
          }
      });
  }
</script>

</body>
</html>
